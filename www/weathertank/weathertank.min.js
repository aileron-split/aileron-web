/************************************************************************

   Copyright (C) 2017, Davor Bokun <bokundavor@gmail.com>

   This program is free software: you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program.  If not, see <http://www.gnu.org/licenses/>.

*************************************************************************/

function createShader(e,a,c){var b=e.createShader(a);e.shaderSource(b,c);e.compileShader(b);var d=e.getShaderParameter(b,e.COMPILE_STATUS);if(d){return b}console.log(e.getShaderInfoLog(b));console.log(c);e.deleteShader(b)}function createProgram(e,d,a){var b=e.createProgram();e.attachShader(b,d);e.attachShader(b,a);e.linkProgram(b);var c=e.getProgramParameter(b,e.LINK_STATUS);if(c){return b}console.log(e.getProgramInfoLog(b));e.deleteProgram(b)}window.onload=function(){var k=document.getElementById("simcanvas");k.width=k.clientWidth;k.height=k.clientHeight;var p=k.getContext("webgl2",{premultipliedAlpha:false});ext=p.getExtension("EXT_color_buffer_float");if(!ext){console.log("need EXT_color_buffer_float");return}ext=p.getExtension("OES_texture_float_linear");if(!ext){console.log("need OES_texture_float_linear");return}var r=new Float32Array(2);var g=new Float32Array(4);var t=new Float32Array(4);k.onmousemove=function(Z){r[0]=Z.clientX/k.width;r[1]=1-Z.clientY/k.height;b.basefluid=" vx: "+g[0].toFixed(2)+", vy: "+g[1].toFixed(2)+", p: "+g[2].toFixed(2)+", div: "+g[3].toFixed(2);b.solutes=" t: "+t[0].toFixed(3)+", w: "+t[1].toFixed(3)+", h: "+t[2].toFixed(3)+", m: "+t[3].toFixed(3)};var O=null;var N=function(){this.program=null;this.vertexShader=null;this.fragmentShader=null;this.positionAttributeLocation=null;this.positionBuffer=null;this.texCoordAttributeLocation=null;this.texCoordBuffer=null;this.bgTexCoordAttributeLocation=null;this.bgTexCoordBuffer=null;this.resolutionUniformLocation=null;this.backgroundImageTintUniformLocation=null;this.backgroundImageBrightnessUniformLocation=null;this.pressureColorUniformLocation=null;this.pressureOpacityUniformLocation=null;this.pressureCutoffUniformLocation=null;this.pressureIORUniformLocation=null;this.updraftColorUniformLocation=null;this.updraftOpacityUniformLocation=null;this.updraftCutoffUniformLocation=null;this.updraftIORUniformLocation=null;this.cloudColorUniformLocation=null;this.cloudOpacityUniformLocation=null;this.cloudCutoffUniformLocation=null;this.cloudIORUniformLocation=null;this.rainColorUniformLocation=null;this.rainOpacityUniformLocation=null;this.rainCutoffUniformLocation=null;this.rainIORUniformLocation=null;this.humidityColorUniformLocation=null;this.humidityOpacityUniformLocation=null;this.humidityCutoffUniformLocation=null;this.humidityIORUniformLocation=null;this.temperatureColorUniformLocation=null;this.temperatureOpacityUniformLocation=null;this.temperatureCutoffUniformLocation=null;this.temperatureIORUniformLocation=null;this.humidityTemperatureColorUniformLocation=null;this.humidityTemperatureOpacityUniformLocation=null;this.humidityTemperatureCutoffUniformLocation=null;this.humidityTemperatureIORUniformLocation=null;this.relativeTemperatureColorUniformLocation=null;this.relativeTemperatureOpacityUniformLocation=null;this.relativeTemperatureCutoffUniformLocation=null;this.relativeTemperatureIORUniformLocation=null;this.updraftTemperatureColorUniformLocation=null;this.updraftTemperatureOpacityUniformLocation=null;this.updraftTemperatureCutoffUniformLocation=null;this.updraftTemperatureIORUniformLocation=null;this.globalStabilityUniformLocation=null;this.inversionAltitudeUniformLocation=null;this.inversionTemperatureUniformLocation=null;this.groundInversionDepthUniformLocation=null;this.groundInversionTemperatureUniformLocation=null;this.backgroundImageTexture=null;this.logoImageTexture=null;this.transferBasefluidTexture=null;this.transferBasefluidFramebuffer=null;this.transferSolutesTexture=null;this.transferSolutesFramebuffer=null;this.u_basefluidLocation=null;this.u_solutesLocation=null;this.u_backgroundLocation=null};var K=function(){this.program=null;this.vertexShader=null;this.fragmentShader=null;this.positionAttributeLocation=null;this.positionBuffer=null;this.texCoordAttributeLocation=null;this.texCoordBuffer=null;this.calcFunctionUniformLocation=null;this.resolutionUniformLocation=null;this.diffusionUniformLocation=null;this.buoyancyFactorUniformLocation=null;this.rainFallingFactorUniformLocation=null;this.globalWindUniformLocation=null;this.globalStabilityUniformLocation=null;this.inversionAltitudeUniformLocation=null;this.inversionTemperatureUniformLocation=null;this.groundInversionDepthUniformLocation=null;this.groundInversionTemperatureUniformLocation=null;this.heatDisipationRateUniformLocation=null;this.temperatureDiffusionUniformLocation=null;this.humidityDiffusionUniformLocation=null;this.condensationFactorUniformLocation=null;this.mistToRainFactorUniformLocation=null;this.rainFallDiffusionUniformLocation=null;this.mistDiffusionUniformLocation=null;this.rainEvaporationUniformLocation=null;this.initialHumidityUniformLocation=null;this.condensationLevelUniformLocation=null;this.latentHeatUniformLocation=null;this.groundTexture=null;this.basefluidTextures=[];this.basefluidFramebuffers=[];this.solutesTextures=[];this.solutesFramebuffers=[];this.u_basefluidLocation=null;this.u_solutesLocation=null;this.u_groundLocation=null};var L=new N();var B=new K();var h=new Uint8Array(16*4);function d(){p.bindTexture(p.TEXTURE_2D,B.groundTexture);p.texImage2D(p.TEXTURE_2D,0,p.RGBA,16,1,0,p.RGBA,p.UNSIGNED_BYTE,h)}function f(){var Z=p.createTexture();p.bindTexture(p.TEXTURE_2D,Z);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_S,p.REPEAT);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,p.CLAMP_TO_EDGE);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,p.NEAREST);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.NEAREST);return Z}var o=false;var G;var z=function(){this.buoyancyFactor=0.01;this.rainFallingFactor=0.01;this.globalWind=0.05;this.globalStability=0.02;this.inversionAltitude=0.9;this.inversionTemperature=0.8;this.groundInversionDepth=0.1;this.groundInversionTemperature=0.3;this.heatDisipationRate=0.0001;this.temperatureDiffusion=0.01;this.humidityDiffusion=0.01;this.condensationFactor=1;this.mistDiffusion=0.01;this.mistToRainFactor=0.001;this.rainFallDiffusion=0.2;this.rainEvaporation=0.00008;this.initialHumidity=0;this.condensationLevel=0.6;this.latentHeat=1;this.stepSize=0.1;this.resolution=256;this.pressureSolveSteps=10;this.diffusion=0.01;this.displayOutline=false;this.backgroundImage=-1;this.backgroundImageTint=[255,255,255];this.backgroundImageBrightness=0;this.pressureColor=[255,0,0];this.pressureOpacity=0;this.pressureCutoff=0;this.pressureIOR=0;this.updraftColor=[255,0,0];this.updraftOpacity=0;this.updraftCutoff=0;this.updraftIOR=0;this.cloudColor=[255,255,255];this.cloudOpacity=1;this.cloudCutoff=0;this.cloudIOR=0;this.rainColor=[120,120,155];this.rainOpacity=1;this.rainCutoff=0;this.rainIOR=0;this.humidityColor=[0,0,255];this.humidityOpacity=1;this.humidityCutoff=0;this.humidityIOR=0;this.temperatureColor=[255,0,0];this.temperatureOpacity=0;this.temperatureCutoff=0;this.temperatureIOR=0;this.humidityTemperatureColor=[255,0,0];this.humidityTemperatureOpacity=0;this.humidityTemperatureCutoff=0;this.humidityTemperatureIOR=0;this.relativeTemperatureColor=[255,0,0];this.relativeTemperatureOpacity=0;this.relativeTemperatureCutoff=0;this.relativeTemperatureIOR=0;this.updraftTemperatureColor=[255,0,0];this.updraftTemperatureOpacity=0;this.updraftTemperatureCutoff=0;this.updraftTemperatureIOR=0;this.runSimulation=function(){if(!o){console.log("START");o=true;requestAnimationFrame(G)}};this.stopSimulation=function(){if(o){o=false;console.log("STOP")}else{console.log("RESET");q()}};this.stepSimulation=function(){if(!o){G();console.log("STEP")}};this.basefluid="";this.solutes=""};var b=new z();function q(){k.width=k.clientWidth;k.height=k.clientHeight;R();E();e();D=0;M=1;A=0;J=1;w(B.solutesFramebuffers[M],11);y();m();b.runSimulation()}function R(){B.program=createProgram(p,B.vertexShader,B.fragmentShader);B.positionAttributeLocation=p.getAttribLocation(B.program,"a_position");B.positionBuffer=p.createBuffer();p.bindBuffer(p.ARRAY_BUFFER,B.positionBuffer);var af=[-1,-1,-1,1,1,-1,-1,1,1,1,1,-1,];p.bufferData(p.ARRAY_BUFFER,new Float32Array(af),p.STATIC_DRAW);B.texCoordAttributeLocation=p.getAttribLocation(B.program,"a_texCoord");B.texCoordBuffer=p.createBuffer();p.bindBuffer(p.ARRAY_BUFFER,B.texCoordBuffer);var ab=[0,0,0,1,1,0,0,1,1,1,1,0,];p.bufferData(p.ARRAY_BUFFER,new Float32Array(ab),p.STATIC_DRAW);B.calcFunctionUniformLocation=p.getUniformLocation(B.program,"u_calcFunction");B.resolutionUniformLocation=p.getUniformLocation(B.program,"u_resolution");B.diffusionUniformLocation=p.getUniformLocation(B.program,"u_diffusion");B.buoyancyFactorUniformLocation=p.getUniformLocation(B.program,"u_buoyancyFactor");B.rainFallingFactorUniformLocation=p.getUniformLocation(B.program,"u_rainFallingFactor");B.globalWindUniformLocation=p.getUniformLocation(B.program,"u_globalWind");B.globalStabilityUniformLocation=p.getUniformLocation(B.program,"u_globalStability");B.inversionAltitudeUniformLocation=p.getUniformLocation(B.program,"u_inversionAltitude");B.inversionTemperatureUniformLocation=p.getUniformLocation(B.program,"u_inversionTemperature");B.groundInversionDepthUniformLocation=p.getUniformLocation(B.program,"u_groundInversionDepth");B.groundInversionTemperatureUniformLocation=p.getUniformLocation(B.program,"u_groundInversionTemperature");B.heatDisipationRateUniformLocation=p.getUniformLocation(B.program,"u_heatDisipationRate");B.temperatureDiffusionUniformLocation=p.getUniformLocation(B.program,"u_temperatureDiffusion");B.humidityDiffusionUniformLocation=p.getUniformLocation(B.program,"u_humidityDiffusion");B.condensationFactorUniformLocation=p.getUniformLocation(B.program,"u_condensationFactor");B.mistDiffusionUniformLocation=p.getUniformLocation(B.program,"u_mistDiffusion");B.mistToRainFactorUniformLocation=p.getUniformLocation(B.program,"u_mistToRainFactor");B.rainFallDiffusionUniformLocation=p.getUniformLocation(B.program,"u_rainFallDiffusion");B.rainEvaporationUniformLocation=p.getUniformLocation(B.program,"u_rainEvaporation");B.initialHumidityUniformLocation=p.getUniformLocation(B.program,"u_initialHumidity");B.condensationLevelUniformLocation=p.getUniformLocation(B.program,"u_condensationLevel");B.latentHeatUniformLocation=p.getUniformLocation(B.program,"u_latentHeat");B.u_basefluidLocation=p.getUniformLocation(B.program,"u_basefluid");B.u_solutesLocation=p.getUniformLocation(B.program,"u_solutes");B.u_groundLocation=p.getUniformLocation(B.program,"u_ground");if(B.groundTexture){p.deleteTexture(B.groundTexture)}B.groundTexture=f();p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.LINEAR);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,p.REPEAT);d();const aa=0;const ac=p.RGBA32F;var ag=b.resolution;const ad=0;const ak=p.RGBA;const ai=p.FLOAT;const ae=null;for(var am=0;am<2;++am){var ah=f();if(am<B.basefluidTextures.length){p.deleteTexture(B.basefluidTextures[am]);B.basefluidTextures[am]=ah}else{B.basefluidTextures.push(ah)}p.texImage2D(p.TEXTURE_2D,aa,ac,ag,ag,ad,ak,ai,ae);var al=p.createFramebuffer();if(am<B.basefluidFramebuffers.length){p.deleteFramebuffer(B.basefluidFramebuffers[am]);B.basefluidFramebuffers[am]=al}else{B.basefluidFramebuffers.push(al)}p.bindFramebuffer(p.FRAMEBUFFER,al);p.framebufferTexture2D(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,p.TEXTURE_2D,ah,0)}for(var am=0;am<2;++am){var Z=f();if(am<B.solutesTextures.length){p.deleteTexture(B.solutesTextures[am]);B.solutesTextures[am]=Z}else{B.solutesTextures.push(Z)}p.texImage2D(p.TEXTURE_2D,aa,ac,ag,ag,ad,ak,ai,ae);var aj=p.createFramebuffer();if(am<B.solutesFramebuffers.length){p.deleteFramebuffer(B.solutesFramebuffers[am]);B.solutesFramebuffers[am]=aj}else{B.solutesFramebuffers.push(aj)}p.bindFramebuffer(p.FRAMEBUFFER,aj);p.framebufferTexture2D(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,p.TEXTURE_2D,Z,0)}}function n(){var ab=0.5*(k.height/H.height-1);var Z=0.5*(k.width/H.width-1);p.bindBuffer(p.ARRAY_BUFFER,L.bgTexCoordBuffer);var aa=[-Z,1+ab,-Z,-ab,1+Z,1+ab,-Z,-ab,1+Z,-ab,1+Z,1+ab,];p.bufferData(p.ARRAY_BUFFER,new Float32Array(aa),p.STATIC_DRAW)}function E(ae){L.program=createProgram(p,L.vertexShader,L.fragmentShader);L.positionAttributeLocation=p.getAttribLocation(L.program,"a_position");L.positionBuffer=p.createBuffer();p.bindBuffer(p.ARRAY_BUFFER,L.positionBuffer);var aa=[-1,-1,-1,1,1,-1,-1,1,1,1,1,-1,];p.bufferData(p.ARRAY_BUFFER,new Float32Array(aa),p.STATIC_DRAW);var af=0.1;var ad=0.1;var ab=1.25;var Z=0.5*(k.width*(af+1+ad)/(k.height*ab)-1);L.texCoordAttributeLocation=p.getAttribLocation(L.program,"a_texCoord");L.texCoordBuffer=p.createBuffer();p.bindBuffer(p.ARRAY_BUFFER,L.texCoordBuffer);var ac=[-Z,-ad,-Z,1+af,1+Z,-ad,-Z,1+af,1+Z,1+af,1+Z,-ad,];p.bufferData(p.ARRAY_BUFFER,new Float32Array(ac),p.STATIC_DRAW);L.bgTexCoordAttributeLocation=p.getAttribLocation(L.program,"a_bgTexCoord");L.bgTexCoordBuffer=p.createBuffer();n();L.resolutionUniformLocation=p.getUniformLocation(L.program,"u_resolution");L.backgroundImageTintUniformLocation=p.getUniformLocation(L.program,"u_backgroundImageTint");L.backgroundImageBrightnessUniformLocation=p.getUniformLocation(L.program,"u_backgroundImageBrightness");L.pressureColorUniformLocation=p.getUniformLocation(L.program,"u_pressureColor");L.pressureOpacityUniformLocation=p.getUniformLocation(L.program,"u_pressureOpacity");L.pressureCutoffUniformLocation=p.getUniformLocation(L.program,"u_pressureCutoff");L.pressureIORUniformLocation=p.getUniformLocation(L.program,"u_pressureIOR");L.updraftColorUniformLocation=p.getUniformLocation(L.program,"u_updraftColor");L.updraftOpacityUniformLocation=p.getUniformLocation(L.program,"u_updraftOpacity");L.updraftCutoffUniformLocation=p.getUniformLocation(L.program,"u_updraftCutoff");L.updraftIORUniformLocation=p.getUniformLocation(L.program,"u_updraftIOR");L.cloudColorUniformLocation=p.getUniformLocation(L.program,"u_cloudColor");L.cloudOpacityUniformLocation=p.getUniformLocation(L.program,"u_cloudOpacity");L.cloudCutoffUniformLocation=p.getUniformLocation(L.program,"u_cloudCutoff");L.cloudIORUniformLocation=p.getUniformLocation(L.program,"u_cloudIOR");L.rainColorUniformLocation=p.getUniformLocation(L.program,"u_rainColor");L.rainOpacityUniformLocation=p.getUniformLocation(L.program,"u_rainOpacity");L.rainCutoffUniformLocation=p.getUniformLocation(L.program,"u_rainCutoff");L.rainIORUniformLocation=p.getUniformLocation(L.program,"u_rainIOR");L.humidityColorUniformLocation=p.getUniformLocation(L.program,"u_humidityColor");L.humidityOpacityUniformLocation=p.getUniformLocation(L.program,"u_humidityOpacity");L.humidityCutoffUniformLocation=p.getUniformLocation(L.program,"u_humidityCutoff");L.humidityIORUniformLocation=p.getUniformLocation(L.program,"u_humidityIOR");L.temperatureColorUniformLocation=p.getUniformLocation(L.program,"u_temperatureColor");L.temperatureOpacityUniformLocation=p.getUniformLocation(L.program,"u_temperatureOpacity");L.temperatureCutoffUniformLocation=p.getUniformLocation(L.program,"u_temperatureCutoff");L.temperatureIORUniformLocation=p.getUniformLocation(L.program,"u_temperatureIOR");L.humidityTemperatureColorUniformLocation=p.getUniformLocation(L.program,"u_humidityTemperatureColor");L.humidityTemperatureOpacityUniformLocation=p.getUniformLocation(L.program,"u_humidityTemperatureOpacity");L.humidityTemperatureCutoffUniformLocation=p.getUniformLocation(L.program,"u_humidityTemperatureCutoff");L.humidityTemperatureIORUniformLocation=p.getUniformLocation(L.program,"u_humidityTemperatureIOR");L.relativeTemperatureColorUniformLocation=p.getUniformLocation(L.program,"u_relativeTemperatureColor");L.relativeTemperatureOpacityUniformLocation=p.getUniformLocation(L.program,"u_relativeTemperatureOpacity");L.relativeTemperatureCutoffUniformLocation=p.getUniformLocation(L.program,"u_relativeTemperatureCutoff");L.relativeTemperatureIORUniformLocation=p.getUniformLocation(L.program,"u_relativeTemperatureIOR");L.updraftTemperatureColorUniformLocation=p.getUniformLocation(L.program,"u_updraftTemperatureColor");L.updraftTemperatureOpacityUniformLocation=p.getUniformLocation(L.program,"u_updraftTemperatureOpacity");L.updraftTemperatureCutoffUniformLocation=p.getUniformLocation(L.program,"u_updraftTemperatureCutoff");L.updraftTemperatureIORUniformLocation=p.getUniformLocation(L.program,"u_updraftTemperatureIOR");L.globalStabilityUniformLocation=p.getUniformLocation(L.program,"u_globalStability");L.inversionAltitudeUniformLocation=p.getUniformLocation(L.program,"u_inversionAltitude");L.inversionTemperatureUniformLocation=p.getUniformLocation(L.program,"u_inversionTemperature");L.groundInversionDepthUniformLocation=p.getUniformLocation(L.program,"u_groundInversionDepth");L.groundInversionTemperatureUniformLocation=p.getUniformLocation(L.program,"u_groundInversionTemperature");L.u_basefluidLocation=p.getUniformLocation(L.program,"u_basefluid");L.u_solutesLocation=p.getUniformLocation(L.program,"u_solutes");L.u_backgroundLocation=p.getUniformLocation(L.program,"u_background");if(L.backgroundImageTexture){p.deleteTexture(L.backgroundImageTexture)}L.backgroundImageTexture=f();p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.LINEAR);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_S,p.REPEAT);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,p.REPEAT);p.texImage2D(p.TEXTURE_2D,0,p.RGBA,p.RGBA,p.UNSIGNED_BYTE,H);if(L.transferBasefluidTexture){p.deleteTexture(L.transferBasefluidTexture)}L.transferBasefluidTexture=f();p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.LINEAR);p.texImage2D(p.TEXTURE_2D,0,p.RGBA32F,b.resolution,b.resolution,0,p.RGBA,p.FLOAT,null);if(L.transferBasefluidFramebuffer){p.deleteFramebuffer(L.transferBasefluidFramebuffer)}L.transferBasefluidFramebuffer=p.createFramebuffer();p.bindFramebuffer(p.FRAMEBUFFER,L.transferBasefluidFramebuffer);p.framebufferTexture2D(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,p.TEXTURE_2D,L.transferBasefluidTexture,0);if(L.transferSolutesTexture){p.deleteTexture(L.transferSolutesTexture)}L.transferSolutesTexture=f();p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.LINEAR);p.texImage2D(p.TEXTURE_2D,0,p.RGBA32F,b.resolution,b.resolution,0,p.RGBA,p.FLOAT,null);if(L.transferSolutesFramebuffer){p.deleteFramebuffer(L.transferSolutesFramebuffer)}L.transferSolutesFramebuffer=p.createFramebuffer();p.bindFramebuffer(p.FRAMEBUFFER,L.transferSolutesFramebuffer);p.framebufferTexture2D(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,p.TEXTURE_2D,L.transferSolutesTexture,0)}var I=[];function s(Z){I[Z-1]=true;if(I.every(function(aa){return aa})){q()}}var C=["./images/aileron-grey.png","./images/squares/squares_00.png","./images/squares/squares_01.png","./images/squares/squares_02.png","./images/squares/squares_03.png","./images/hexes/hexes_00.png","./images/hexes/hexes_01.png","./images/aileron.png","./images/aileron-inv.png",];var H=new Image();function F(){if(L.backgroundImageTexture){H.onload=function(){p.bindTexture(p.TEXTURE_2D,L.backgroundImageTexture);p.texImage2D(p.TEXTURE_2D,0,p.RGBA,p.RGBA,p.UNSIGNED_BYTE,H);n();e()};H.src=C[b.backgroundImage]}}var a=new XMLHttpRequest();var W=I.push(false);a.open("GET","shaders/weathersolver.vert",true);a.onload=function(Z){if(this.status==200){B.vertexShader=createShader(p,p.VERTEX_SHADER,a.response);s(W)}};a.send(null);var S=new XMLHttpRequest();var P=I.push(false);S.open("GET","shaders/weathersolver.frag",true);S.onload=function(Z){if(this.status==200){B.fragmentShader=createShader(p,p.FRAGMENT_SHADER,S.response);s(P)}};S.send(null);var T=new XMLHttpRequest();var u=I.push(false);T.open("GET","shaders/weatherrenderer.vert",true);T.onload=function(Z){if(this.status==200){L.vertexShader=createShader(p,p.VERTEX_SHADER,T.response);s(u)}};T.send(null);var U=new XMLHttpRequest();var v=I.push(false);U.open("GET","shaders/weatherrenderer.frag",true);U.onload=function(Z){if(this.status==200){L.fragmentShader=createShader(p,p.FRAGMENT_SHADER,U.response);s(v)}};U.send(null);function j(ab){O=new dat.GUI({load:ab});O.remember(b);var aa=O.addFolder("Simulation Params");var af=aa.addFolder("Stability");af.add(b,"globalWind").min(-1).max(1).step(0.01);af.add(b,"globalStability").min(0).max(0.5).step(0.01);af.add(b,"inversionAltitude").min(0.5).max(1).step(0.01);af.add(b,"inversionTemperature").min(0.5).max(1.5).step(0.01);af.add(b,"groundInversionDepth").min(0).max(0.5).step(0.01);af.add(b,"groundInversionTemperature").min(0).max(0.5).step(0.01);af.add(b,"heatDisipationRate").min(0).max(0.005).step(0.0001);af.add(b,"buoyancyFactor").min(0).max(0.1).step(0.001);af.add(b,"rainFallingFactor").min(0).max(0.1).step(0.001);var ad=aa.addFolder("Water Content");ad.add(b,"temperatureDiffusion").min(0).max(0.1).step(0.01);ad.add(b,"humidityDiffusion").min(0).max(0.1).step(0.01);ad.add(b,"condensationFactor").min(0).max(1).step(0.01);ad.add(b,"mistDiffusion").min(0).max(0.1).step(0.01);ad.add(b,"mistToRainFactor").min(0).max(0.01).step(0.0001);ad.add(b,"rainFallDiffusion").min(0).max(1).step(0.001);ad.add(b,"rainEvaporation").min(0).max(0.001).step(0.00001);ad.add(b,"initialHumidity").min(0).max(1).step(0.01);ad.add(b,"condensationLevel").min(0).max(1).step(0.01);ad.add(b,"latentHeat").min(0).max(5).step(0.1);var Z=O.addFolder("Solver Settings");Z.add(b,"resolution",[64,128,256,512,1024,2048,4096]).onChange(Q);Z.add(b,"pressureSolveSteps").min(1).max(30).step(1);Z.add(b,"diffusion").min(0).max(1).step(0.01);var an=O.addFolder("Display Options");an.add(b,"displayOutline").onChange(e);an.add(b,"backgroundImage",[0,1,2,3,4,5,6,7,8]).onChange(F);an.addColor(b,"backgroundImageTint").onChange(e);an.add(b,"backgroundImageBrightness").min(-1).max(1).step(0.01).onChange(e);var am=an.addFolder("Pressure");am.addColor(b,"pressureColor").onChange(e);am.add(b,"pressureOpacity").min(0).max(100000).step(100).onChange(e);am.add(b,"pressureCutoff").min(0).max(0.01).step(0.00001).onChange(e);am.add(b,"pressureIOR").min(-100).max(100).step(1).onChange(e);var al=an.addFolder("Updraft");al.addColor(b,"updraftColor").onChange(e);al.add(b,"updraftOpacity").min(0).max(15).step(0.01).onChange(e);al.add(b,"updraftCutoff").min(0).max(1).step(0.001).onChange(e);al.add(b,"updraftIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var ak=an.addFolder("Cloud");ak.addColor(b,"cloudColor").onChange(e);ak.add(b,"cloudOpacity").min(0).max(70).step(0.1).onChange(e);ak.add(b,"cloudCutoff").min(0).max(1).step(0.001).onChange(e);ak.add(b,"cloudIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var aj=an.addFolder("Rain");aj.addColor(b,"rainColor").onChange(e);aj.add(b,"rainOpacity").min(0).max(30).step(0.1).onChange(e);aj.add(b,"rainCutoff").min(0).max(1).step(0.001).onChange(e);aj.add(b,"rainIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var ai=an.addFolder("Humidity");ai.addColor(b,"humidityColor").onChange(e);ai.add(b,"humidityOpacity").min(0).max(15).step(0.1).onChange(e);ai.add(b,"humidityCutoff").min(0).max(1).step(0.001).onChange(e);ai.add(b,"humidityIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var ah=an.addFolder("Temperature");ah.addColor(b,"temperatureColor").onChange(e);ah.add(b,"temperatureOpacity").min(0).max(15).step(0.1).onChange(e);ah.add(b,"temperatureCutoff").min(0).max(1).step(0.001).onChange(e);ah.add(b,"temperatureIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var ag=an.addFolder("Humidity Temperature");ag.addColor(b,"humidityTemperatureColor").onChange(e);ag.add(b,"humidityTemperatureOpacity").min(0).max(15).step(0.01).onChange(e);ag.add(b,"humidityTemperatureCutoff").min(0).max(1).step(0.001).onChange(e);ag.add(b,"humidityTemperatureIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var ae=an.addFolder("Relative Temperature");ae.addColor(b,"relativeTemperatureColor").onChange(e);ae.add(b,"relativeTemperatureOpacity").min(0).max(15).step(0.01).onChange(e);ae.add(b,"relativeTemperatureCutoff").min(0).max(1).step(0.001).onChange(e);ae.add(b,"relativeTemperatureIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var ac=an.addFolder("Updraft Temperature");ac.addColor(b,"updraftTemperatureColor").onChange(e);ac.add(b,"updraftTemperatureOpacity").min(0).max(15).step(0.01).onChange(e);ac.add(b,"updraftTemperatureCutoff").min(0).max(1).step(0.001).onChange(e);ac.add(b,"updraftTemperatureIOR").min(-0.1).max(0.1).step(0.001).onChange(e);O.add(b,"runSimulation");O.add(b,"stopSimulation");O.add(b,"stepSimulation");O.add(b,"basefluid").listen();O.add(b,"solutes").listen()}var X=new XMLHttpRequest();var x=I.push(false);X.open("GET","presets.json",true);X.onload=function(aa){if(this.status==200){j(JSON.parse(X.response));var Z=I.push(false);H.onload=function(){s(Z)};H.src=C[b.backgroundImage];s(x)}};X.send(null);function Y(ab){var aa;var Z;if(ab==null){aa=p.canvas.width;Z=p.canvas.height}else{aa=b.resolution;Z=b.resolution}p.bindFramebuffer(p.FRAMEBUFFER,ab);p.viewport(0,0,parseFloat(aa),parseFloat(Z))}var A=0;var J=1;var D=0;var M=1;function y(){D=(D==0)?1:0;M=(M==0)?1:0}function V(){A=(A==0)?1:0;J=(J==0)?1:0}function w(af,ae){p.useProgram(B.program);p.uniform1i(B.u_basefluidLocation,0);p.uniform1i(B.u_solutesLocation,1);p.uniform1i(B.u_groundLocation,2);p.activeTexture(p.TEXTURE0);p.bindTexture(p.TEXTURE_2D,B.basefluidTextures[A]);p.activeTexture(p.TEXTURE1);p.bindTexture(p.TEXTURE_2D,B.solutesTextures[D]);p.activeTexture(p.TEXTURE2);d();Y(af);p.uniform1f(B.resolutionUniformLocation,b.resolution);p.enableVertexAttribArray(B.positionAttributeLocation);p.bindBuffer(p.ARRAY_BUFFER,B.positionBuffer);var ah=2;var ad=p.FLOAT;var ab=false;var Z=0;var aa=0;p.vertexAttribPointer(B.positionAttributeLocation,ah,ad,ab,Z,aa);p.enableVertexAttribArray(B.texCoordAttributeLocation);p.bindBuffer(p.ARRAY_BUFFER,B.texCoordBuffer);var ah=2;var ad=p.FLOAT;var ab=false;var Z=0;var aa=0;p.vertexAttribPointer(B.texCoordAttributeLocation,ah,ad,ab,Z,aa);p.uniform1i(B.calcFunctionUniformLocation,ae);p.uniform1f(B.diffusionUniformLocation,b.diffusion);p.uniform1f(B.buoyancyFactorUniformLocation,b.buoyancyFactor);p.uniform1f(B.rainFallingFactorUniformLocation,b.rainFallingFactor);p.uniform1f(B.globalWindUniformLocation,b.globalWind);p.uniform1f(B.globalStabilityUniformLocation,b.globalStability);p.uniform1f(B.inversionAltitudeUniformLocation,b.inversionAltitude);p.uniform1f(B.inversionTemperatureUniformLocation,b.inversionTemperature);p.uniform1f(B.groundInversionDepthUniformLocation,b.groundInversionDepth);p.uniform1f(B.groundInversionTemperatureUniformLocation,b.groundInversionTemperature);p.uniform1f(B.heatDisipationRateUniformLocation,b.heatDisipationRate);p.uniform1f(B.temperatureDiffusionUniformLocation,b.temperatureDiffusion);p.uniform1f(B.humidityDiffusionUniformLocation,b.humidityDiffusion);p.uniform1f(B.condensationFactorUniformLocation,b.condensationFactor);p.uniform1f(B.mistDiffusionUniformLocation,b.mistDiffusion);p.uniform1f(B.mistToRainFactorUniformLocation,b.mistToRainFactor);p.uniform1f(B.rainFallDiffusionUniformLocation,b.rainFallDiffusion);p.uniform1f(B.rainEvaporationUniformLocation,b.rainEvaporation);p.uniform1f(B.initialHumidityUniformLocation,b.initialHumidity);p.uniform1f(B.condensationLevelUniformLocation,b.condensationLevel);p.uniform1f(B.latentHeatUniformLocation,b.latentHeat);var ag=p.TRIANGLES;var aa=0;var ac=6;p.drawArrays(ag,aa,ac)}function m(){w(L.transferBasefluidFramebuffer,0);p.readPixels(r[0]*l,r[1]*l,1,1,p.RGBA,p.FLOAT,g);w(L.transferSolutesFramebuffer,1);p.readPixels(r[0]*l,r[1]*l,1,1,p.RGBA,p.FLOAT,t);p.useProgram(L.program);p.uniform1i(L.u_basefluidLocation,0);p.uniform1i(L.u_solutesLocation,1);p.uniform1i(L.u_backgroundLocation,2);p.activeTexture(p.TEXTURE0);p.bindTexture(p.TEXTURE_2D,L.transferBasefluidTexture);p.activeTexture(p.TEXTURE1);p.bindTexture(p.TEXTURE_2D,L.transferSolutesTexture);p.activeTexture(p.TEXTURE2);p.bindTexture(p.TEXTURE_2D,L.backgroundImageTexture);Y(null);p.uniform2f(L.resolutionUniformLocation,b.resolution,b.resolution);p.enableVertexAttribArray(L.positionAttributeLocation);p.bindBuffer(p.ARRAY_BUFFER,L.positionBuffer);p.vertexAttribPointer(L.positionAttributeLocation,2,p.FLOAT,false,0,0);p.enableVertexAttribArray(L.texCoordAttributeLocation);p.bindBuffer(p.ARRAY_BUFFER,L.texCoordBuffer);p.vertexAttribPointer(L.texCoordAttributeLocation,2,p.FLOAT,false,0,0);p.enableVertexAttribArray(L.bgTexCoordAttributeLocation);p.bindBuffer(p.ARRAY_BUFFER,L.bgTexCoordBuffer);p.vertexAttribPointer(L.bgTexCoordAttributeLocation,2,p.FLOAT,false,0,0);p.uniform3f(L.backgroundImageTintUniformLocation,b.backgroundImageTint[0]/256,b.backgroundImageTint[1]/256,b.backgroundImageTint[2]/256);p.uniform1f(L.backgroundImageBrightnessUniformLocation,b.backgroundImageBrightness);p.uniform3f(L.pressureColorUniformLocation,b.pressureColor[0]/256,b.pressureColor[1]/256,b.pressureColor[2]/256);p.uniform1f(L.pressureOpacityUniformLocation,b.pressureOpacity);p.uniform1f(L.pressureCutoffUniformLocation,b.pressureCutoff);p.uniform1f(L.pressureIORUniformLocation,b.pressureIOR);p.uniform3f(L.updraftColorUniformLocation,b.updraftColor[0]/256,b.updraftColor[1]/256,b.updraftColor[2]/256);p.uniform1f(L.updraftOpacityUniformLocation,b.updraftOpacity);p.uniform1f(L.updraftCutoffUniformLocation,b.updraftCutoff);p.uniform1f(L.updraftIORUniformLocation,b.updraftIOR);p.uniform3f(L.cloudColorUniformLocation,b.cloudColor[0]/256,b.cloudColor[1]/256,b.cloudColor[2]/256);p.uniform1f(L.cloudOpacityUniformLocation,b.cloudOpacity);p.uniform1f(L.cloudCutoffUniformLocation,b.cloudCutoff);p.uniform1f(L.cloudIORUniformLocation,b.cloudIOR);p.uniform3f(L.rainColorUniformLocation,b.rainColor[0]/256,b.rainColor[1]/256,b.rainColor[2]/256);p.uniform1f(L.rainOpacityUniformLocation,b.rainOpacity);p.uniform1f(L.rainCutoffUniformLocation,b.rainCutoff);p.uniform1f(L.rainIORUniformLocation,b.rainIOR);p.uniform3f(L.humidityColorUniformLocation,b.humidityColor[0]/256,b.humidityColor[1]/256,b.humidityColor[2]/256);p.uniform1f(L.humidityOpacityUniformLocation,b.humidityOpacity);p.uniform1f(L.humidityCutoffUniformLocation,b.humidityCutoff);p.uniform1f(L.humidityIORUniformLocation,b.humidityIOR);p.uniform3f(L.temperatureColorUniformLocation,b.temperatureColor[0]/256,b.temperatureColor[1]/256,b.temperatureColor[2]/256);p.uniform1f(L.temperatureOpacityUniformLocation,b.temperatureOpacity);p.uniform1f(L.temperatureCutoffUniformLocation,b.temperatureCutoff);p.uniform1f(L.temperatureIORUniformLocation,b.temperatureIOR);p.uniform3f(L.humidityTemperatureColorUniformLocation,b.humidityTemperatureColor[0]/256,b.humidityTemperatureColor[1]/256,b.humidityTemperatureColor[2]/256);p.uniform1f(L.humidityTemperatureOpacityUniformLocation,b.humidityTemperatureOpacity);p.uniform1f(L.humidityTemperatureCutoffUniformLocation,b.humidityTemperatureCutoff);p.uniform1f(L.humidityTemperatureIORUniformLocation,b.humidityTemperatureIOR);p.uniform3f(L.relativeTemperatureColorUniformLocation,b.relativeTemperatureColor[0]/256,b.relativeTemperatureColor[1]/256,b.relativeTemperatureColor[2]/256);p.uniform1f(L.relativeTemperatureOpacityUniformLocation,b.relativeTemperatureOpacity);p.uniform1f(L.relativeTemperatureCutoffUniformLocation,b.relativeTemperatureCutoff);p.uniform1f(L.relativeTemperatureIORUniformLocation,b.relativeTemperatureIOR);p.uniform3f(L.updraftTemperatureColorUniformLocation,b.updraftTemperatureColor[0]/256,b.updraftTemperatureColor[1]/256,b.updraftTemperatureColor[2]/256);p.uniform1f(L.updraftTemperatureOpacityUniformLocation,b.updraftTemperatureOpacity);p.uniform1f(L.updraftTemperatureCutoffUniformLocation,b.updraftTemperatureCutoff);p.uniform1f(L.updraftTemperatureIORUniformLocation,b.updraftTemperatureIOR);p.uniform1f(L.globalStabilityUniformLocation,b.globalStability);p.uniform1f(L.inversionAltitudeUniformLocation,b.inversionAltitude);p.uniform1f(L.inversionTemperatureUniformLocation,b.inversionTemperature);p.uniform1f(L.groundInversionDepthUniformLocation,b.groundInversionDepth);p.uniform1f(L.groundInversionTemperatureUniformLocation,b.groundInversionTemperature);var Z=p.TRIANGLES;var ab=0;var aa=6;p.drawArrays(Z,ab,aa)}var e=function(){if(b.displayOutline){k.style.border="1px  solid red"}else{k.style.border="none"}if(!o){m()}};var c=function(Z){w(B.basefluidFramebuffers[J],4);V();for(var aa=1;aa<b.pressureSolveSteps;aa+=1){w(B.basefluidFramebuffers[J],5);V()}w(B.basefluidFramebuffers[J],6);V()};function i(Z,aa,ab){h[Z*4+0]=aa;h[Z*4+2]=ab}G=function(){i(2,70,0);i(3,70,10);i(4,170,10);i(5,70,10);i(8,170,10);i(9,70,0);i(12,0,50);i(13,0,50);w(B.basefluidFramebuffers[J],9);V();w(B.solutesFramebuffers[M],10);y();w(B.basefluidFramebuffers[J],2);V();w(B.solutesFramebuffers[M],7);y();c();w(B.basefluidFramebuffers[J],3);V();w(B.solutesFramebuffers[M],8);y();c();m();if(o){requestAnimationFrame(G)}};var l=256;function Q(Z){if(Z!=l){q();l=Z}}};