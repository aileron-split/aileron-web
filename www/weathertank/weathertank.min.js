/************************************************************************

   WeatherTank - WebGL boundary layer weather simulation.

   Copyright (C) 2017, Davor Bokun <bokundavor@gmail.com>

   This program is free software: you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program.  If not, see <http://www.gnu.org/licenses/>.

*************************************************************************/

function createShader(e,a,c){var b=e.createShader(a);e.shaderSource(b,c);e.compileShader(b);var d=e.getShaderParameter(b,e.COMPILE_STATUS);if(d){return b}console.log(e.getShaderInfoLog(b));console.log(c);e.deleteShader(b)}function createProgram(e,d,a){var b=e.createProgram();e.attachShader(b,d);e.attachShader(b,a);e.linkProgram(b);var c=e.getProgramParameter(b,e.LINK_STATUS);if(c){return b}console.log(e.getProgramInfoLog(b));e.deleteProgram(b)}window.onload=function(){var k=document.getElementById("simcanvas");k.width=k.clientWidth;k.height=k.clientHeight;var p=k.getContext("webgl2",{premultipliedAlpha:false});ext=p.getExtension("EXT_color_buffer_float");if(!ext){console.log("need EXT_color_buffer_float");return}ext=p.getExtension("OES_texture_float_linear");if(!ext){console.log("need OES_texture_float_linear");return}var s=new Float32Array(2);var g=new Float32Array(4);var u=new Float32Array(4);k.onmousemove=function(ag){s[0]=ag.clientX/k.width;s[1]=1-ag.clientY/k.height;if(!o){z()}};var U=null;var T=function(){this.program=null;this.vertexShader=null;this.fragmentShader=null;this.positionAttributeLocation=null;this.positionBuffer=null;this.texCoordAttributeLocation=null;this.texCoordBuffer=null;this.bgTexCoordAttributeLocation=null;this.bgTexCoordBuffer=null;this.resolutionUniformLocation=null;this.backgroundImageTintUniformLocation=null;this.backgroundImageBrightnessUniformLocation=null;this.pressureColorUniformLocation=null;this.pressureOpacityUniformLocation=null;this.pressureCutoffUniformLocation=null;this.pressureIORUniformLocation=null;this.updraftColorUniformLocation=null;this.updraftOpacityUniformLocation=null;this.updraftCutoffUniformLocation=null;this.updraftIORUniformLocation=null;this.cloudColorUniformLocation=null;this.cloudOpacityUniformLocation=null;this.cloudCutoffUniformLocation=null;this.cloudIORUniformLocation=null;this.rainColorUniformLocation=null;this.rainOpacityUniformLocation=null;this.rainCutoffUniformLocation=null;this.rainIORUniformLocation=null;this.humidityColorUniformLocation=null;this.humidityOpacityUniformLocation=null;this.humidityCutoffUniformLocation=null;this.humidityIORUniformLocation=null;this.temperatureColorUniformLocation=null;this.temperatureOpacityUniformLocation=null;this.temperatureCutoffUniformLocation=null;this.temperatureIORUniformLocation=null;this.humidityTemperatureColorUniformLocation=null;this.humidityTemperatureOpacityUniformLocation=null;this.humidityTemperatureCutoffUniformLocation=null;this.humidityTemperatureIORUniformLocation=null;this.relativeTemperatureColorUniformLocation=null;this.relativeTemperatureOpacityUniformLocation=null;this.relativeTemperatureCutoffUniformLocation=null;this.relativeTemperatureIORUniformLocation=null;this.updraftTemperatureColorUniformLocation=null;this.updraftTemperatureOpacityUniformLocation=null;this.updraftTemperatureCutoffUniformLocation=null;this.updraftTemperatureIORUniformLocation=null;this.globalStabilityUniformLocation=null;this.inversionAltitudeUniformLocation=null;this.inversionTemperatureUniformLocation=null;this.groundInversionDepthUniformLocation=null;this.groundInversionTemperatureUniformLocation=null;this.backgroundImageTexture=null;this.logoImageTexture=null;this.transferBasefluidTexture=null;this.transferBasefluidFramebuffer=null;this.transferSolutesTexture=null;this.transferSolutesFramebuffer=null;this.u_basefluidLocation=null;this.u_solutesLocation=null;this.u_backgroundLocation=null};var O=function(){this.program=null;this.vertexShader=null;this.fragmentShader=null;this.positionAttributeLocation=null;this.positionBuffer=null;this.texCoordAttributeLocation=null;this.texCoordBuffer=null;this.calcFunctionUniformLocation=null;this.resolutionUniformLocation=null;this.diffusionUniformLocation=null;this.buoyancyFactorUniformLocation=null;this.rainFallingFactorUniformLocation=null;this.globalWindUniformLocation=null;this.globalStabilityUniformLocation=null;this.inversionAltitudeUniformLocation=null;this.inversionTemperatureUniformLocation=null;this.groundInversionDepthUniformLocation=null;this.groundInversionTemperatureUniformLocation=null;this.heatDisipationRateUniformLocation=null;this.temperatureDiffusionUniformLocation=null;this.humidityDiffusionUniformLocation=null;this.condensationFactorUniformLocation=null;this.mistToRainFactorUniformLocation=null;this.rainFallDiffusionUniformLocation=null;this.mistDiffusionUniformLocation=null;this.rainEvaporationUniformLocation=null;this.initialHumidityUniformLocation=null;this.condensationLevelUniformLocation=null;this.latentHeatUniformLocation=null;this.groundTexture=null;this.basefluidTextures=[];this.basefluidFramebuffers=[];this.solutesTextures=[];this.solutesFramebuffers=[];this.u_basefluidLocation=null;this.u_solutesLocation=null;this.u_groundLocation=null};var P=new T();var E=new O();var h=new Uint8Array(16*4);function d(){p.bindTexture(p.TEXTURE_2D,E.groundTexture);p.texImage2D(p.TEXTURE_2D,0,p.RGBA,16,1,0,p.RGBA,p.UNSIGNED_BYTE,h)}function f(){var ag=p.createTexture();p.bindTexture(p.TEXTURE_2D,ag);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_S,p.REPEAT);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,p.CLAMP_TO_EDGE);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,p.NEAREST);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.NEAREST);return ag}var o=window.location.hash!="#nostart";var K;var B=function(){this.buoyancyFactor=0.01;this.rainFallingFactor=0.01;this.globalWind=0.05;this.globalStability=0.02;this.inversionAltitude=0.9;this.inversionTemperature=0.8;this.groundInversionDepth=0.1;this.groundInversionTemperature=0.3;this.heatDisipationRate=0.0001;this.temperatureDiffusion=0.01;this.humidityDiffusion=0.01;this.condensationFactor=1;this.mistDiffusion=0.01;this.mistToRainFactor=0.001;this.rainFallDiffusion=0.2;this.rainEvaporation=0.00008;this.initialHumidity=0;this.condensationLevel=0.6;this.latentHeat=1;this.stepSize=0.1;this.resolution=256;this.pressureSolveSteps=10;this.diffusion=0.01;this.displayOutline=false;this.backgroundImage=-1;this.backgroundImageTint=[255,255,255];this.backgroundImageBrightness=0;this.pressureColor=[255,0,0];this.pressureOpacity=0;this.pressureCutoff=0;this.pressureIOR=0;this.updraftColor=[255,0,0];this.updraftOpacity=0;this.updraftCutoff=0;this.updraftIOR=0;this.cloudColor=[255,255,255];this.cloudOpacity=1;this.cloudCutoff=0;this.cloudIOR=0;this.rainColor=[120,120,155];this.rainOpacity=1;this.rainCutoff=0;this.rainIOR=0;this.humidityColor=[0,0,255];this.humidityOpacity=1;this.humidityCutoff=0;this.humidityIOR=0;this.temperatureColor=[255,0,0];this.temperatureOpacity=0;this.temperatureCutoff=0;this.temperatureIOR=0;this.humidityTemperatureColor=[255,0,0];this.humidityTemperatureOpacity=0;this.humidityTemperatureCutoff=0;this.humidityTemperatureIOR=0;this.relativeTemperatureColor=[255,0,0];this.relativeTemperatureOpacity=0;this.relativeTemperatureCutoff=0;this.relativeTemperatureIOR=0;this.updraftTemperatureColor=[255,0,0];this.updraftTemperatureOpacity=0;this.updraftTemperatureCutoff=0;this.updraftTemperatureIOR=0;this.runSimulation=function(){if(!o){console.log("START");o=true;requestAnimationFrame(K)}};this.stopSimulation=function(){if(o){o=false;console.log("STOP")}else{console.log("RESET");r()}};this.stepSimulation=function(){if(!o){K();console.log("STEP")}};this.basefluid="";this.solutes=""};var b=new B();function r(){k.width=k.clientWidth;k.height=k.clientHeight;X();H();e();G=0;Q=1;D=0;N=1;x(E.solutesFramebuffers[Q],11);A();m();K()}function X(){E.program=createProgram(p,E.vertexShader,E.fragmentShader);E.positionAttributeLocation=p.getAttribLocation(E.program,"a_position");E.positionBuffer=p.createBuffer();p.bindBuffer(p.ARRAY_BUFFER,E.positionBuffer);var am=[-1,-1,-1,1,1,-1,-1,1,1,1,1,-1,];p.bufferData(p.ARRAY_BUFFER,new Float32Array(am),p.STATIC_DRAW);E.texCoordAttributeLocation=p.getAttribLocation(E.program,"a_texCoord");E.texCoordBuffer=p.createBuffer();p.bindBuffer(p.ARRAY_BUFFER,E.texCoordBuffer);var ai=[0,0,0,1,1,0,0,1,1,1,1,0,];p.bufferData(p.ARRAY_BUFFER,new Float32Array(ai),p.STATIC_DRAW);E.calcFunctionUniformLocation=p.getUniformLocation(E.program,"u_calcFunction");E.resolutionUniformLocation=p.getUniformLocation(E.program,"u_resolution");E.diffusionUniformLocation=p.getUniformLocation(E.program,"u_diffusion");E.buoyancyFactorUniformLocation=p.getUniformLocation(E.program,"u_buoyancyFactor");E.rainFallingFactorUniformLocation=p.getUniformLocation(E.program,"u_rainFallingFactor");E.globalWindUniformLocation=p.getUniformLocation(E.program,"u_globalWind");E.globalStabilityUniformLocation=p.getUniformLocation(E.program,"u_globalStability");E.inversionAltitudeUniformLocation=p.getUniformLocation(E.program,"u_inversionAltitude");E.inversionTemperatureUniformLocation=p.getUniformLocation(E.program,"u_inversionTemperature");E.groundInversionDepthUniformLocation=p.getUniformLocation(E.program,"u_groundInversionDepth");E.groundInversionTemperatureUniformLocation=p.getUniformLocation(E.program,"u_groundInversionTemperature");E.heatDisipationRateUniformLocation=p.getUniformLocation(E.program,"u_heatDisipationRate");E.temperatureDiffusionUniformLocation=p.getUniformLocation(E.program,"u_temperatureDiffusion");E.humidityDiffusionUniformLocation=p.getUniformLocation(E.program,"u_humidityDiffusion");E.condensationFactorUniformLocation=p.getUniformLocation(E.program,"u_condensationFactor");E.mistDiffusionUniformLocation=p.getUniformLocation(E.program,"u_mistDiffusion");E.mistToRainFactorUniformLocation=p.getUniformLocation(E.program,"u_mistToRainFactor");E.rainFallDiffusionUniformLocation=p.getUniformLocation(E.program,"u_rainFallDiffusion");E.rainEvaporationUniformLocation=p.getUniformLocation(E.program,"u_rainEvaporation");E.initialHumidityUniformLocation=p.getUniformLocation(E.program,"u_initialHumidity");E.condensationLevelUniformLocation=p.getUniformLocation(E.program,"u_condensationLevel");E.latentHeatUniformLocation=p.getUniformLocation(E.program,"u_latentHeat");E.u_basefluidLocation=p.getUniformLocation(E.program,"u_basefluid");E.u_solutesLocation=p.getUniformLocation(E.program,"u_solutes");E.u_groundLocation=p.getUniformLocation(E.program,"u_ground");if(E.groundTexture){p.deleteTexture(E.groundTexture)}E.groundTexture=f();p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.LINEAR);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,p.REPEAT);d();const ah=0;const aj=p.RGBA32F;var an=b.resolution;const ak=0;const ar=p.RGBA;const ap=p.FLOAT;const al=null;for(var au=0;au<2;++au){var ao=f();if(au<E.basefluidTextures.length){p.deleteTexture(E.basefluidTextures[au]);E.basefluidTextures[au]=ao}else{E.basefluidTextures.push(ao)}p.texImage2D(p.TEXTURE_2D,ah,aj,an,an,ak,ar,ap,al);var at=p.createFramebuffer();if(au<E.basefluidFramebuffers.length){p.deleteFramebuffer(E.basefluidFramebuffers[au]);E.basefluidFramebuffers[au]=at}else{E.basefluidFramebuffers.push(at)}p.bindFramebuffer(p.FRAMEBUFFER,at);p.framebufferTexture2D(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,p.TEXTURE_2D,ao,0)}for(var au=0;au<2;++au){var ag=f();if(au<E.solutesTextures.length){p.deleteTexture(E.solutesTextures[au]);E.solutesTextures[au]=ag}else{E.solutesTextures.push(ag)}p.texImage2D(p.TEXTURE_2D,ah,aj,an,an,ak,ar,ap,al);var aq=p.createFramebuffer();if(au<E.solutesFramebuffers.length){p.deleteFramebuffer(E.solutesFramebuffers[au]);E.solutesFramebuffers[au]=aq}else{E.solutesFramebuffers.push(aq)}p.bindFramebuffer(p.FRAMEBUFFER,aq);p.framebufferTexture2D(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,p.TEXTURE_2D,ag,0)}}function n(){var ai=0.5*(k.height/L.height-1);var ag=0.5*(k.width/L.width-1);p.bindBuffer(p.ARRAY_BUFFER,P.bgTexCoordBuffer);var ah=[-ag,1+ai,-ag,-ai,1+ag,1+ai,-ag,-ai,1+ag,-ai,1+ag,1+ai,];p.bufferData(p.ARRAY_BUFFER,new Float32Array(ah),p.STATIC_DRAW)}var q=0.1;var ab=0.1;var S=1.25;var R=0.5*(k.width*(q+1+ab)/(k.height*S)-1);function C(){p.bindBuffer(p.ARRAY_BUFFER,P.texCoordBuffer);var ag=[-R,-ab,-R,1+q,1+R,-ab,-R,1+q,1+R,1+q,1+R,-ab,];p.bufferData(p.ARRAY_BUFFER,new Float32Array(ag),p.STATIC_DRAW)}function J(ah){var ag=ah[0]*(1+2*R)-R;var ai=ah[1]*(1+ab+q)-ab;return[ag,ai]}function H(ah){P.program=createProgram(p,P.vertexShader,P.fragmentShader);P.positionAttributeLocation=p.getAttribLocation(P.program,"a_position");P.positionBuffer=p.createBuffer();p.bindBuffer(p.ARRAY_BUFFER,P.positionBuffer);var ag=[-1,-1,-1,1,1,-1,-1,1,1,1,1,-1,];p.bufferData(p.ARRAY_BUFFER,new Float32Array(ag),p.STATIC_DRAW);P.texCoordAttributeLocation=p.getAttribLocation(P.program,"a_texCoord");P.texCoordBuffer=p.createBuffer();C();P.bgTexCoordAttributeLocation=p.getAttribLocation(P.program,"a_bgTexCoord");P.bgTexCoordBuffer=p.createBuffer();n();P.resolutionUniformLocation=p.getUniformLocation(P.program,"u_resolution");P.backgroundImageTintUniformLocation=p.getUniformLocation(P.program,"u_backgroundImageTint");P.backgroundImageBrightnessUniformLocation=p.getUniformLocation(P.program,"u_backgroundImageBrightness");P.pressureColorUniformLocation=p.getUniformLocation(P.program,"u_pressureColor");P.pressureOpacityUniformLocation=p.getUniformLocation(P.program,"u_pressureOpacity");P.pressureCutoffUniformLocation=p.getUniformLocation(P.program,"u_pressureCutoff");P.pressureIORUniformLocation=p.getUniformLocation(P.program,"u_pressureIOR");P.updraftColorUniformLocation=p.getUniformLocation(P.program,"u_updraftColor");P.updraftOpacityUniformLocation=p.getUniformLocation(P.program,"u_updraftOpacity");P.updraftCutoffUniformLocation=p.getUniformLocation(P.program,"u_updraftCutoff");P.updraftIORUniformLocation=p.getUniformLocation(P.program,"u_updraftIOR");P.cloudColorUniformLocation=p.getUniformLocation(P.program,"u_cloudColor");P.cloudOpacityUniformLocation=p.getUniformLocation(P.program,"u_cloudOpacity");P.cloudCutoffUniformLocation=p.getUniformLocation(P.program,"u_cloudCutoff");P.cloudIORUniformLocation=p.getUniformLocation(P.program,"u_cloudIOR");P.rainColorUniformLocation=p.getUniformLocation(P.program,"u_rainColor");P.rainOpacityUniformLocation=p.getUniformLocation(P.program,"u_rainOpacity");P.rainCutoffUniformLocation=p.getUniformLocation(P.program,"u_rainCutoff");P.rainIORUniformLocation=p.getUniformLocation(P.program,"u_rainIOR");P.humidityColorUniformLocation=p.getUniformLocation(P.program,"u_humidityColor");P.humidityOpacityUniformLocation=p.getUniformLocation(P.program,"u_humidityOpacity");P.humidityCutoffUniformLocation=p.getUniformLocation(P.program,"u_humidityCutoff");P.humidityIORUniformLocation=p.getUniformLocation(P.program,"u_humidityIOR");P.temperatureColorUniformLocation=p.getUniformLocation(P.program,"u_temperatureColor");P.temperatureOpacityUniformLocation=p.getUniformLocation(P.program,"u_temperatureOpacity");P.temperatureCutoffUniformLocation=p.getUniformLocation(P.program,"u_temperatureCutoff");P.temperatureIORUniformLocation=p.getUniformLocation(P.program,"u_temperatureIOR");P.humidityTemperatureColorUniformLocation=p.getUniformLocation(P.program,"u_humidityTemperatureColor");P.humidityTemperatureOpacityUniformLocation=p.getUniformLocation(P.program,"u_humidityTemperatureOpacity");P.humidityTemperatureCutoffUniformLocation=p.getUniformLocation(P.program,"u_humidityTemperatureCutoff");P.humidityTemperatureIORUniformLocation=p.getUniformLocation(P.program,"u_humidityTemperatureIOR");P.relativeTemperatureColorUniformLocation=p.getUniformLocation(P.program,"u_relativeTemperatureColor");P.relativeTemperatureOpacityUniformLocation=p.getUniformLocation(P.program,"u_relativeTemperatureOpacity");P.relativeTemperatureCutoffUniformLocation=p.getUniformLocation(P.program,"u_relativeTemperatureCutoff");P.relativeTemperatureIORUniformLocation=p.getUniformLocation(P.program,"u_relativeTemperatureIOR");P.updraftTemperatureColorUniformLocation=p.getUniformLocation(P.program,"u_updraftTemperatureColor");P.updraftTemperatureOpacityUniformLocation=p.getUniformLocation(P.program,"u_updraftTemperatureOpacity");P.updraftTemperatureCutoffUniformLocation=p.getUniformLocation(P.program,"u_updraftTemperatureCutoff");P.updraftTemperatureIORUniformLocation=p.getUniformLocation(P.program,"u_updraftTemperatureIOR");P.globalStabilityUniformLocation=p.getUniformLocation(P.program,"u_globalStability");P.inversionAltitudeUniformLocation=p.getUniformLocation(P.program,"u_inversionAltitude");P.inversionTemperatureUniformLocation=p.getUniformLocation(P.program,"u_inversionTemperature");P.groundInversionDepthUniformLocation=p.getUniformLocation(P.program,"u_groundInversionDepth");P.groundInversionTemperatureUniformLocation=p.getUniformLocation(P.program,"u_groundInversionTemperature");P.u_basefluidLocation=p.getUniformLocation(P.program,"u_basefluid");P.u_solutesLocation=p.getUniformLocation(P.program,"u_solutes");P.u_backgroundLocation=p.getUniformLocation(P.program,"u_background");if(P.backgroundImageTexture){p.deleteTexture(P.backgroundImageTexture)}P.backgroundImageTexture=f();p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.LINEAR);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_S,p.REPEAT);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,p.REPEAT);p.texImage2D(p.TEXTURE_2D,0,p.RGBA,p.RGBA,p.UNSIGNED_BYTE,L);if(P.transferBasefluidTexture){p.deleteTexture(P.transferBasefluidTexture)}P.transferBasefluidTexture=f();p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.LINEAR);p.texImage2D(p.TEXTURE_2D,0,p.RGBA32F,b.resolution,b.resolution,0,p.RGBA,p.FLOAT,null);if(P.transferBasefluidFramebuffer){p.deleteFramebuffer(P.transferBasefluidFramebuffer)}P.transferBasefluidFramebuffer=p.createFramebuffer();p.bindFramebuffer(p.FRAMEBUFFER,P.transferBasefluidFramebuffer);p.framebufferTexture2D(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,p.TEXTURE_2D,P.transferBasefluidTexture,0);if(P.transferSolutesTexture){p.deleteTexture(P.transferSolutesTexture)}P.transferSolutesTexture=f();p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.LINEAR);p.texImage2D(p.TEXTURE_2D,0,p.RGBA32F,b.resolution,b.resolution,0,p.RGBA,p.FLOAT,null);if(P.transferSolutesFramebuffer){p.deleteFramebuffer(P.transferSolutesFramebuffer)}P.transferSolutesFramebuffer=p.createFramebuffer();p.bindFramebuffer(p.FRAMEBUFFER,P.transferSolutesFramebuffer);p.framebufferTexture2D(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,p.TEXTURE_2D,P.transferSolutesTexture,0)}var M=[];function t(ag){M[ag-1]=true;if(M.every(function(ah){return ah})){r()}}var F=["./images/aileron-grey.png","./images/squares/squares_00.png","./images/squares/squares_01.png","./images/squares/squares_02.png","./images/squares/squares_03.png","./images/hexes/hexes_00.png","./images/hexes/hexes_01.png","./images/aileron.png","./images/aileron-inv.png",];var L=new Image();function I(){if(P.backgroundImageTexture){L.onload=function(){p.bindTexture(p.TEXTURE_2D,P.backgroundImageTexture);p.texImage2D(p.TEXTURE_2D,0,p.RGBA,p.RGBA,p.UNSIGNED_BYTE,L);n();e()};L.src=F[b.backgroundImage]}}var a=new XMLHttpRequest();var ad=M.push(false);a.open("GET","shaders/weathersolver.vert",true);a.onload=function(ag){if(this.status==200){E.vertexShader=createShader(p,p.VERTEX_SHADER,a.response);t(ad)}};a.send(null);var Y=new XMLHttpRequest();var V=M.push(false);Y.open("GET","shaders/weathersolver.frag",true);Y.onload=function(ag){if(this.status==200){E.fragmentShader=createShader(p,p.FRAGMENT_SHADER,Y.response);t(V)}};Y.send(null);var aa=new XMLHttpRequest();var w=M.push(false);aa.open("GET","shaders/weatherrenderer.vert",true);aa.onload=function(ag){if(this.status==200){P.vertexShader=createShader(p,p.VERTEX_SHADER,aa.response);t(w)}};aa.send(null);var Z=new XMLHttpRequest();var v=M.push(false);Z.open("GET","shaders/weatherrenderer.frag",true);Z.onload=function(ag){if(this.status==200){P.fragmentShader=createShader(p,p.FRAGMENT_SHADER,Z.response);t(v)}};Z.send(null);function j(ai){U=new dat.GUI({load:ai});U.remember(b);var ah=U.addFolder("Simulation Params");var am=ah.addFolder("Stability");am.add(b,"globalWind").min(-1).max(1).step(0.01);am.add(b,"globalStability").min(0).max(0.5).step(0.01);am.add(b,"inversionAltitude").min(0.5).max(1).step(0.01);am.add(b,"inversionTemperature").min(0.5).max(1.5).step(0.01);am.add(b,"groundInversionDepth").min(0).max(0.5).step(0.01);am.add(b,"groundInversionTemperature").min(0).max(0.5).step(0.01);am.add(b,"heatDisipationRate").min(0).max(0.005).step(0.0001);am.add(b,"buoyancyFactor").min(0).max(0.1).step(0.001);am.add(b,"rainFallingFactor").min(0).max(0.1).step(0.001);var ak=ah.addFolder("Water Content");ak.add(b,"temperatureDiffusion").min(0).max(0.1).step(0.01);ak.add(b,"humidityDiffusion").min(0).max(0.1).step(0.01);ak.add(b,"condensationFactor").min(0).max(1).step(0.01);ak.add(b,"mistDiffusion").min(0).max(0.1).step(0.01);ak.add(b,"mistToRainFactor").min(0).max(0.01).step(0.0001);ak.add(b,"rainFallDiffusion").min(0).max(1).step(0.001);ak.add(b,"rainEvaporation").min(0).max(0.001).step(0.00001);ak.add(b,"initialHumidity").min(0).max(1).step(0.01);ak.add(b,"condensationLevel").min(0).max(1).step(0.01);ak.add(b,"latentHeat").min(0).max(5).step(0.1);var ag=U.addFolder("Solver Settings");ag.add(b,"resolution",[64,128,256,512,1024,2048,4096]).onChange(W);ag.add(b,"pressureSolveSteps").min(1).max(30).step(1);ag.add(b,"diffusion").min(0).max(1).step(0.01);var av=U.addFolder("Display Options");av.add(b,"displayOutline").onChange(e);av.add(b,"backgroundImage",[0,1,2,3,4,5,6,7,8]).onChange(I);av.addColor(b,"backgroundImageTint").onChange(e);av.add(b,"backgroundImageBrightness").min(-1).max(1).step(0.01).onChange(e);var au=av.addFolder("Pressure");au.addColor(b,"pressureColor").onChange(e);au.add(b,"pressureOpacity").min(0).max(100000).step(100).onChange(e);au.add(b,"pressureCutoff").min(0).max(0.01).step(0.00001).onChange(e);au.add(b,"pressureIOR").min(-100).max(100).step(1).onChange(e);var at=av.addFolder("Updraft");at.addColor(b,"updraftColor").onChange(e);at.add(b,"updraftOpacity").min(0).max(15).step(0.01).onChange(e);at.add(b,"updraftCutoff").min(0).max(1).step(0.001).onChange(e);at.add(b,"updraftIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var ar=av.addFolder("Cloud");ar.addColor(b,"cloudColor").onChange(e);ar.add(b,"cloudOpacity").min(0).max(70).step(0.1).onChange(e);ar.add(b,"cloudCutoff").min(0).max(1).step(0.001).onChange(e);ar.add(b,"cloudIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var aq=av.addFolder("Rain");aq.addColor(b,"rainColor").onChange(e);aq.add(b,"rainOpacity").min(0).max(30).step(0.1).onChange(e);aq.add(b,"rainCutoff").min(0).max(1).step(0.001).onChange(e);aq.add(b,"rainIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var ap=av.addFolder("Humidity");ap.addColor(b,"humidityColor").onChange(e);ap.add(b,"humidityOpacity").min(0).max(15).step(0.1).onChange(e);ap.add(b,"humidityCutoff").min(0).max(1).step(0.001).onChange(e);ap.add(b,"humidityIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var ao=av.addFolder("Temperature");ao.addColor(b,"temperatureColor").onChange(e);ao.add(b,"temperatureOpacity").min(0).max(15).step(0.1).onChange(e);ao.add(b,"temperatureCutoff").min(0).max(1).step(0.001).onChange(e);ao.add(b,"temperatureIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var an=av.addFolder("Humidity Temperature");an.addColor(b,"humidityTemperatureColor").onChange(e);an.add(b,"humidityTemperatureOpacity").min(0).max(15).step(0.01).onChange(e);an.add(b,"humidityTemperatureCutoff").min(0).max(1).step(0.001).onChange(e);an.add(b,"humidityTemperatureIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var al=av.addFolder("Relative Temperature");al.addColor(b,"relativeTemperatureColor").onChange(e);al.add(b,"relativeTemperatureOpacity").min(0).max(15).step(0.01).onChange(e);al.add(b,"relativeTemperatureCutoff").min(0).max(1).step(0.001).onChange(e);al.add(b,"relativeTemperatureIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var aj=av.addFolder("Updraft Temperature");aj.addColor(b,"updraftTemperatureColor").onChange(e);aj.add(b,"updraftTemperatureOpacity").min(0).max(15).step(0.01).onChange(e);aj.add(b,"updraftTemperatureCutoff").min(0).max(1).step(0.001).onChange(e);aj.add(b,"updraftTemperatureIOR").min(-0.1).max(0.1).step(0.001).onChange(e);U.add(b,"runSimulation");U.add(b,"stopSimulation");U.add(b,"stepSimulation");U.add(b,"basefluid").listen();U.add(b,"solutes").listen()}var ae=new XMLHttpRequest();var y=M.push(false);ae.open("GET","presets.json",true);ae.onload=function(ah){if(this.status==200){j(JSON.parse(ae.response));var ag=M.push(false);L.onload=function(){t(ag)};L.src=F[b.backgroundImage];t(y)}};ae.send(null);function af(ai){var ah;var ag;if(ai==null){ah=p.canvas.width;ag=p.canvas.height}else{ah=b.resolution;ag=b.resolution}p.bindFramebuffer(p.FRAMEBUFFER,ai);p.viewport(0,0,parseFloat(ah),parseFloat(ag))}var D=0;var N=1;var G=0;var Q=1;function A(){G=(G==0)?1:0;Q=(Q==0)?1:0}function ac(){D=(D==0)?1:0;N=(N==0)?1:0}function x(am,al){p.useProgram(E.program);p.uniform1i(E.u_basefluidLocation,0);p.uniform1i(E.u_solutesLocation,1);p.uniform1i(E.u_groundLocation,2);p.activeTexture(p.TEXTURE0);p.bindTexture(p.TEXTURE_2D,E.basefluidTextures[D]);p.activeTexture(p.TEXTURE1);p.bindTexture(p.TEXTURE_2D,E.solutesTextures[G]);p.activeTexture(p.TEXTURE2);d();af(am);p.uniform1f(E.resolutionUniformLocation,b.resolution);p.enableVertexAttribArray(E.positionAttributeLocation);p.bindBuffer(p.ARRAY_BUFFER,E.positionBuffer);var ao=2;var ak=p.FLOAT;var ai=false;var ag=0;var ah=0;p.vertexAttribPointer(E.positionAttributeLocation,ao,ak,ai,ag,ah);p.enableVertexAttribArray(E.texCoordAttributeLocation);p.bindBuffer(p.ARRAY_BUFFER,E.texCoordBuffer);var ao=2;var ak=p.FLOAT;var ai=false;var ag=0;var ah=0;p.vertexAttribPointer(E.texCoordAttributeLocation,ao,ak,ai,ag,ah);p.uniform1i(E.calcFunctionUniformLocation,al);p.uniform1f(E.diffusionUniformLocation,b.diffusion);p.uniform1f(E.buoyancyFactorUniformLocation,b.buoyancyFactor);p.uniform1f(E.rainFallingFactorUniformLocation,b.rainFallingFactor);p.uniform1f(E.globalWindUniformLocation,b.globalWind);p.uniform1f(E.globalStabilityUniformLocation,b.globalStability);p.uniform1f(E.inversionAltitudeUniformLocation,b.inversionAltitude);p.uniform1f(E.inversionTemperatureUniformLocation,b.inversionTemperature);p.uniform1f(E.groundInversionDepthUniformLocation,b.groundInversionDepth);p.uniform1f(E.groundInversionTemperatureUniformLocation,b.groundInversionTemperature);p.uniform1f(E.heatDisipationRateUniformLocation,b.heatDisipationRate);p.uniform1f(E.temperatureDiffusionUniformLocation,b.temperatureDiffusion);p.uniform1f(E.humidityDiffusionUniformLocation,b.humidityDiffusion);p.uniform1f(E.condensationFactorUniformLocation,b.condensationFactor);p.uniform1f(E.mistDiffusionUniformLocation,b.mistDiffusion);p.uniform1f(E.mistToRainFactorUniformLocation,b.mistToRainFactor);p.uniform1f(E.rainFallDiffusionUniformLocation,b.rainFallDiffusion);p.uniform1f(E.rainEvaporationUniformLocation,b.rainEvaporation);p.uniform1f(E.initialHumidityUniformLocation,b.initialHumidity);p.uniform1f(E.condensationLevelUniformLocation,b.condensationLevel);p.uniform1f(E.latentHeatUniformLocation,b.latentHeat);var an=p.TRIANGLES;var ah=0;var aj=6;p.drawArrays(an,ah,aj)}function z(){if(!o){var ag=J(s);p.bindFramebuffer(p.FRAMEBUFFER,P.transferBasefluidFramebuffer);p.readPixels(ag[0]*l,ag[1]*l,1,1,p.RGBA,p.FLOAT,g);p.bindFramebuffer(p.FRAMEBUFFER,P.transferSolutesFramebuffer);p.readPixels(ag[0]*l,ag[1]*l,1,1,p.RGBA,p.FLOAT,u)}b.basefluid=" vx: "+g[0].toFixed(2)+", vy: "+g[1].toFixed(2)+", t: "+u[0].toFixed(3);b.solutes=" h: "+u[2].toFixed(3)+", m: "+u[3].toFixed(3)+", r: "+u[1].toFixed(3)}function m(){var ai=J(s);x(P.transferBasefluidFramebuffer,0);p.readPixels(ai[0]*l,ai[1]*l,1,1,p.RGBA,p.FLOAT,g);x(P.transferSolutesFramebuffer,1);p.readPixels(ai[0]*l,ai[1]*l,1,1,p.RGBA,p.FLOAT,u);z();p.useProgram(P.program);p.uniform1i(P.u_basefluidLocation,0);p.uniform1i(P.u_solutesLocation,1);p.uniform1i(P.u_backgroundLocation,2);p.activeTexture(p.TEXTURE0);p.bindTexture(p.TEXTURE_2D,P.transferBasefluidTexture);p.activeTexture(p.TEXTURE1);p.bindTexture(p.TEXTURE_2D,P.transferSolutesTexture);p.activeTexture(p.TEXTURE2);p.bindTexture(p.TEXTURE_2D,P.backgroundImageTexture);af(null);p.uniform2f(P.resolutionUniformLocation,b.resolution,b.resolution);p.enableVertexAttribArray(P.positionAttributeLocation);p.bindBuffer(p.ARRAY_BUFFER,P.positionBuffer);p.vertexAttribPointer(P.positionAttributeLocation,2,p.FLOAT,false,0,0);p.enableVertexAttribArray(P.texCoordAttributeLocation);p.bindBuffer(p.ARRAY_BUFFER,P.texCoordBuffer);p.vertexAttribPointer(P.texCoordAttributeLocation,2,p.FLOAT,false,0,0);p.enableVertexAttribArray(P.bgTexCoordAttributeLocation);p.bindBuffer(p.ARRAY_BUFFER,P.bgTexCoordBuffer);p.vertexAttribPointer(P.bgTexCoordAttributeLocation,2,p.FLOAT,false,0,0);p.uniform3f(P.backgroundImageTintUniformLocation,b.backgroundImageTint[0]/256,b.backgroundImageTint[1]/256,b.backgroundImageTint[2]/256);p.uniform1f(P.backgroundImageBrightnessUniformLocation,b.backgroundImageBrightness);p.uniform3f(P.pressureColorUniformLocation,b.pressureColor[0]/256,b.pressureColor[1]/256,b.pressureColor[2]/256);p.uniform1f(P.pressureOpacityUniformLocation,b.pressureOpacity);p.uniform1f(P.pressureCutoffUniformLocation,b.pressureCutoff);p.uniform1f(P.pressureIORUniformLocation,b.pressureIOR);p.uniform3f(P.updraftColorUniformLocation,b.updraftColor[0]/256,b.updraftColor[1]/256,b.updraftColor[2]/256);p.uniform1f(P.updraftOpacityUniformLocation,b.updraftOpacity);p.uniform1f(P.updraftCutoffUniformLocation,b.updraftCutoff);p.uniform1f(P.updraftIORUniformLocation,b.updraftIOR);p.uniform3f(P.cloudColorUniformLocation,b.cloudColor[0]/256,b.cloudColor[1]/256,b.cloudColor[2]/256);p.uniform1f(P.cloudOpacityUniformLocation,b.cloudOpacity);p.uniform1f(P.cloudCutoffUniformLocation,b.cloudCutoff);p.uniform1f(P.cloudIORUniformLocation,b.cloudIOR);p.uniform3f(P.rainColorUniformLocation,b.rainColor[0]/256,b.rainColor[1]/256,b.rainColor[2]/256);p.uniform1f(P.rainOpacityUniformLocation,b.rainOpacity);p.uniform1f(P.rainCutoffUniformLocation,b.rainCutoff);p.uniform1f(P.rainIORUniformLocation,b.rainIOR);p.uniform3f(P.humidityColorUniformLocation,b.humidityColor[0]/256,b.humidityColor[1]/256,b.humidityColor[2]/256);p.uniform1f(P.humidityOpacityUniformLocation,b.humidityOpacity);p.uniform1f(P.humidityCutoffUniformLocation,b.humidityCutoff);p.uniform1f(P.humidityIORUniformLocation,b.humidityIOR);p.uniform3f(P.temperatureColorUniformLocation,b.temperatureColor[0]/256,b.temperatureColor[1]/256,b.temperatureColor[2]/256);p.uniform1f(P.temperatureOpacityUniformLocation,b.temperatureOpacity);p.uniform1f(P.temperatureCutoffUniformLocation,b.temperatureCutoff);p.uniform1f(P.temperatureIORUniformLocation,b.temperatureIOR);p.uniform3f(P.humidityTemperatureColorUniformLocation,b.humidityTemperatureColor[0]/256,b.humidityTemperatureColor[1]/256,b.humidityTemperatureColor[2]/256);p.uniform1f(P.humidityTemperatureOpacityUniformLocation,b.humidityTemperatureOpacity);p.uniform1f(P.humidityTemperatureCutoffUniformLocation,b.humidityTemperatureCutoff);p.uniform1f(P.humidityTemperatureIORUniformLocation,b.humidityTemperatureIOR);p.uniform3f(P.relativeTemperatureColorUniformLocation,b.relativeTemperatureColor[0]/256,b.relativeTemperatureColor[1]/256,b.relativeTemperatureColor[2]/256);p.uniform1f(P.relativeTemperatureOpacityUniformLocation,b.relativeTemperatureOpacity);p.uniform1f(P.relativeTemperatureCutoffUniformLocation,b.relativeTemperatureCutoff);p.uniform1f(P.relativeTemperatureIORUniformLocation,b.relativeTemperatureIOR);p.uniform3f(P.updraftTemperatureColorUniformLocation,b.updraftTemperatureColor[0]/256,b.updraftTemperatureColor[1]/256,b.updraftTemperatureColor[2]/256);p.uniform1f(P.updraftTemperatureOpacityUniformLocation,b.updraftTemperatureOpacity);p.uniform1f(P.updraftTemperatureCutoffUniformLocation,b.updraftTemperatureCutoff);p.uniform1f(P.updraftTemperatureIORUniformLocation,b.updraftTemperatureIOR);p.uniform1f(P.globalStabilityUniformLocation,b.globalStability);p.uniform1f(P.inversionAltitudeUniformLocation,b.inversionAltitude);p.uniform1f(P.inversionTemperatureUniformLocation,b.inversionTemperature);p.uniform1f(P.groundInversionDepthUniformLocation,b.groundInversionDepth);p.uniform1f(P.groundInversionTemperatureUniformLocation,b.groundInversionTemperature);var ag=p.TRIANGLES;var aj=0;var ah=6;p.drawArrays(ag,aj,ah)}var e=function(){if(b.displayOutline){k.style.border="1px  solid red"}else{k.style.border="none"}if(!o){m()}};var c=function(ag){x(E.basefluidFramebuffers[N],4);ac();for(var ah=1;ah<b.pressureSolveSteps;ah+=1){x(E.basefluidFramebuffers[N],5);ac()}x(E.basefluidFramebuffers[N],6);ac()};function i(ag,ah,ai){h[ag*4+0]=ah;h[ag*4+2]=ai}K=function(){i(2,70,0);i(3,70,10);i(4,170,10);i(5,70,10);i(8,170,10);i(9,70,0);i(12,0,50);i(13,0,50);x(E.basefluidFramebuffers[N],9);ac();x(E.solutesFramebuffers[Q],10);A();x(E.basefluidFramebuffers[N],2);ac();x(E.solutesFramebuffers[Q],7);A();c();x(E.basefluidFramebuffers[N],3);ac();x(E.solutesFramebuffers[Q],8);A();c();m();if(o){requestAnimationFrame(K)}};var l=256;function W(ag){if(ag!=l){r();l=ag}}};