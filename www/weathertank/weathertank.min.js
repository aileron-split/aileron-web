/************************************************************************

   WeatherTank - WebGL boundary layer weather simulation.

   Copyright (C) 2017, Davor Bokun <bokundavor@gmail.com>

   This program is free software: you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program.  If not, see <http://www.gnu.org/licenses/>.

*************************************************************************/

function createShader(e,a,c){var b=e.createShader(a);e.shaderSource(b,c);e.compileShader(b);var d=e.getShaderParameter(b,e.COMPILE_STATUS);if(d){return b}console.log(e.getShaderInfoLog(b));console.log(c);e.deleteShader(b)}function createProgram(e,d,a){var b=e.createProgram();e.attachShader(b,d);e.attachShader(b,a);e.linkProgram(b);var c=e.getProgramParameter(b,e.LINK_STATUS);if(c){return b}console.log(e.getProgramInfoLog(b));e.deleteProgram(b)}window.onload=function(){var k=document.getElementById("simcanvas");k.width=k.clientWidth;k.height=k.clientHeight;var q=k.getContext("webgl2",{premultipliedAlpha:false});var l=true;ext=q.getExtension("EXT_color_buffer_float");if(!ext){console.log("need EXT_color_buffer_float");return}ext=q.getExtension("OES_texture_float_linear");if(!ext){console.log("No OES_texture_float_linear extension available, falling back to NEAREST");l=false}var t=new Float32Array(2);var g=new Float32Array(4);var v=new Float32Array(4);k.onmousemove=function(ah){t[0]=ah.clientX/k.width;t[1]=1-ah.clientY/k.height;if(!p){A()}};var V=null;var U=function(){this.program=null;this.vertexShader=null;this.fragmentShader=null;this.positionAttributeLocation=null;this.positionBuffer=null;this.texCoordAttributeLocation=null;this.texCoordBuffer=null;this.bgTexCoordAttributeLocation=null;this.bgTexCoordBuffer=null;this.resolutionUniformLocation=null;this.backgroundImageTintUniformLocation=null;this.backgroundImageBrightnessUniformLocation=null;this.pressureColorUniformLocation=null;this.pressureOpacityUniformLocation=null;this.pressureCutoffUniformLocation=null;this.pressureIORUniformLocation=null;this.updraftColorUniformLocation=null;this.updraftOpacityUniformLocation=null;this.updraftCutoffUniformLocation=null;this.updraftIORUniformLocation=null;this.cloudColorUniformLocation=null;this.cloudOpacityUniformLocation=null;this.cloudCutoffUniformLocation=null;this.cloudIORUniformLocation=null;this.rainColorUniformLocation=null;this.rainOpacityUniformLocation=null;this.rainCutoffUniformLocation=null;this.rainIORUniformLocation=null;this.humidityColorUniformLocation=null;this.humidityOpacityUniformLocation=null;this.humidityCutoffUniformLocation=null;this.humidityIORUniformLocation=null;this.temperatureColorUniformLocation=null;this.temperatureOpacityUniformLocation=null;this.temperatureCutoffUniformLocation=null;this.temperatureIORUniformLocation=null;this.humidityTemperatureColorUniformLocation=null;this.humidityTemperatureOpacityUniformLocation=null;this.humidityTemperatureCutoffUniformLocation=null;this.humidityTemperatureIORUniformLocation=null;this.relativeTemperatureColorUniformLocation=null;this.relativeTemperatureOpacityUniformLocation=null;this.relativeTemperatureCutoffUniformLocation=null;this.relativeTemperatureIORUniformLocation=null;this.updraftTemperatureColorUniformLocation=null;this.updraftTemperatureOpacityUniformLocation=null;this.updraftTemperatureCutoffUniformLocation=null;this.updraftTemperatureIORUniformLocation=null;this.globalStabilityUniformLocation=null;this.inversionAltitudeUniformLocation=null;this.inversionTemperatureUniformLocation=null;this.groundInversionDepthUniformLocation=null;this.groundInversionTemperatureUniformLocation=null;this.backgroundImageTexture=null;this.transferBasefluidTexture=null;this.transferBasefluidFramebuffer=null;this.transferSolutesTexture=null;this.transferSolutesFramebuffer=null;this.u_basefluidLocation=null;this.u_solutesLocation=null;this.u_backgroundLocation=null};var P=function(){this.program=null;this.vertexShader=null;this.fragmentShader=null;this.positionAttributeLocation=null;this.positionBuffer=null;this.texCoordAttributeLocation=null;this.texCoordBuffer=null;this.calcFunctionUniformLocation=null;this.resolutionUniformLocation=null;this.diffusionUniformLocation=null;this.buoyancyFactorUniformLocation=null;this.rainFallingFactorUniformLocation=null;this.globalWindUniformLocation=null;this.globalStabilityUniformLocation=null;this.inversionAltitudeUniformLocation=null;this.inversionTemperatureUniformLocation=null;this.groundInversionDepthUniformLocation=null;this.groundInversionTemperatureUniformLocation=null;this.heatDisipationRateUniformLocation=null;this.temperatureDiffusionUniformLocation=null;this.humidityDiffusionUniformLocation=null;this.condensationFactorUniformLocation=null;this.mistToRainFactorUniformLocation=null;this.rainFallDiffusionUniformLocation=null;this.mistDiffusionUniformLocation=null;this.rainEvaporationUniformLocation=null;this.initialHumidityUniformLocation=null;this.condensationLevelUniformLocation=null;this.latentHeatUniformLocation=null;this.groundTexture=null;this.basefluidTextures=[];this.basefluidFramebuffers=[];this.solutesTextures=[];this.solutesFramebuffers=[];this.u_basefluidLocation=null;this.u_solutesLocation=null;this.u_groundLocation=null};var Q=new U();var F=new P();var h=new Uint8Array(16*4);function d(){q.bindTexture(q.TEXTURE_2D,F.groundTexture);q.texImage2D(q.TEXTURE_2D,0,q.RGBA,16,1,0,q.RGBA,q.UNSIGNED_BYTE,h)}function f(){var ah=q.createTexture();q.bindTexture(q.TEXTURE_2D,ah);q.texParameteri(q.TEXTURE_2D,q.TEXTURE_WRAP_S,q.REPEAT);q.texParameteri(q.TEXTURE_2D,q.TEXTURE_WRAP_T,q.CLAMP_TO_EDGE);q.texParameteri(q.TEXTURE_2D,q.TEXTURE_MIN_FILTER,q.NEAREST);q.texParameteri(q.TEXTURE_2D,q.TEXTURE_MAG_FILTER,q.NEAREST);return ah}var p=window.location.hash!="#nostart";var L;var C=function(){this.buoyancyFactor=0.01;this.rainFallingFactor=0.01;this.globalWind=0.05;this.globalStability=0.02;this.inversionAltitude=0.9;this.inversionTemperature=0.8;this.groundInversionDepth=0.1;this.groundInversionTemperature=0.3;this.heatDisipationRate=0.0001;this.temperatureDiffusion=0.01;this.humidityDiffusion=0.01;this.condensationFactor=1;this.mistDiffusion=0.01;this.mistToRainFactor=0.001;this.rainFallDiffusion=0.2;this.rainEvaporation=0.00008;this.initialHumidity=0;this.condensationLevel=0.6;this.latentHeat=1;this.stepSize=0.1;this.resolution=256;this.pressureSolveSteps=10;this.diffusion=0.01;this.displayOutline=false;this.backgroundImage=-1;this.backgroundImageTint=[255,255,255];this.backgroundImageBrightness=0;this.pressureColor=[255,0,0];this.pressureOpacity=0;this.pressureCutoff=0;this.pressureIOR=0;this.updraftColor=[255,0,0];this.updraftOpacity=0;this.updraftCutoff=0;this.updraftIOR=0;this.cloudColor=[255,255,255];this.cloudOpacity=1;this.cloudCutoff=0;this.cloudIOR=0;this.rainColor=[120,120,155];this.rainOpacity=1;this.rainCutoff=0;this.rainIOR=0;this.humidityColor=[0,0,255];this.humidityOpacity=1;this.humidityCutoff=0;this.humidityIOR=0;this.temperatureColor=[255,0,0];this.temperatureOpacity=0;this.temperatureCutoff=0;this.temperatureIOR=0;this.humidityTemperatureColor=[255,0,0];this.humidityTemperatureOpacity=0;this.humidityTemperatureCutoff=0;this.humidityTemperatureIOR=0;this.relativeTemperatureColor=[255,0,0];this.relativeTemperatureOpacity=0;this.relativeTemperatureCutoff=0;this.relativeTemperatureIOR=0;this.updraftTemperatureColor=[255,0,0];this.updraftTemperatureOpacity=0;this.updraftTemperatureCutoff=0;this.updraftTemperatureIOR=0;this.runSimulation=function(){if(!p){console.log("START");p=true;requestAnimationFrame(L)}};this.stopSimulation=function(){if(p){p=false;console.log("STOP")}else{console.log("RESET");s()}};this.stepSimulation=function(){if(!p){L();console.log("STEP")}};this.basefluid="";this.solutes=""};var b=new C();function s(ah){k.width=k.clientWidth;k.height=k.clientHeight;Y();I();e();H=0;R=1;E=0;O=1;y(F.solutesFramebuffers[R],11);B();n();if(!ah){L()}}function Y(){F.program=createProgram(q,F.vertexShader,F.fragmentShader);F.positionAttributeLocation=q.getAttribLocation(F.program,"a_position");F.positionBuffer=q.createBuffer();q.bindBuffer(q.ARRAY_BUFFER,F.positionBuffer);var an=[-1,-1,-1,1,1,-1,-1,1,1,1,1,-1,];q.bufferData(q.ARRAY_BUFFER,new Float32Array(an),q.STATIC_DRAW);F.texCoordAttributeLocation=q.getAttribLocation(F.program,"a_texCoord");F.texCoordBuffer=q.createBuffer();q.bindBuffer(q.ARRAY_BUFFER,F.texCoordBuffer);var aj=[0,0,0,1,1,0,0,1,1,1,1,0,];q.bufferData(q.ARRAY_BUFFER,new Float32Array(aj),q.STATIC_DRAW);F.calcFunctionUniformLocation=q.getUniformLocation(F.program,"u_calcFunction");F.resolutionUniformLocation=q.getUniformLocation(F.program,"u_resolution");F.diffusionUniformLocation=q.getUniformLocation(F.program,"u_diffusion");F.buoyancyFactorUniformLocation=q.getUniformLocation(F.program,"u_buoyancyFactor");F.rainFallingFactorUniformLocation=q.getUniformLocation(F.program,"u_rainFallingFactor");F.globalWindUniformLocation=q.getUniformLocation(F.program,"u_globalWind");F.globalStabilityUniformLocation=q.getUniformLocation(F.program,"u_globalStability");F.inversionAltitudeUniformLocation=q.getUniformLocation(F.program,"u_inversionAltitude");F.inversionTemperatureUniformLocation=q.getUniformLocation(F.program,"u_inversionTemperature");F.groundInversionDepthUniformLocation=q.getUniformLocation(F.program,"u_groundInversionDepth");F.groundInversionTemperatureUniformLocation=q.getUniformLocation(F.program,"u_groundInversionTemperature");F.heatDisipationRateUniformLocation=q.getUniformLocation(F.program,"u_heatDisipationRate");F.temperatureDiffusionUniformLocation=q.getUniformLocation(F.program,"u_temperatureDiffusion");F.humidityDiffusionUniformLocation=q.getUniformLocation(F.program,"u_humidityDiffusion");F.condensationFactorUniformLocation=q.getUniformLocation(F.program,"u_condensationFactor");F.mistDiffusionUniformLocation=q.getUniformLocation(F.program,"u_mistDiffusion");F.mistToRainFactorUniformLocation=q.getUniformLocation(F.program,"u_mistToRainFactor");F.rainFallDiffusionUniformLocation=q.getUniformLocation(F.program,"u_rainFallDiffusion");F.rainEvaporationUniformLocation=q.getUniformLocation(F.program,"u_rainEvaporation");F.initialHumidityUniformLocation=q.getUniformLocation(F.program,"u_initialHumidity");F.condensationLevelUniformLocation=q.getUniformLocation(F.program,"u_condensationLevel");F.latentHeatUniformLocation=q.getUniformLocation(F.program,"u_latentHeat");F.u_basefluidLocation=q.getUniformLocation(F.program,"u_basefluid");F.u_solutesLocation=q.getUniformLocation(F.program,"u_solutes");F.u_groundLocation=q.getUniformLocation(F.program,"u_ground");if(F.groundTexture){q.deleteTexture(F.groundTexture)}F.groundTexture=f();q.texParameteri(q.TEXTURE_2D,q.TEXTURE_MAG_FILTER,q.LINEAR);q.texParameteri(q.TEXTURE_2D,q.TEXTURE_WRAP_T,q.REPEAT);d();const ai=0;const ak=q.RGBA32F;var ao=b.resolution;const al=0;const at=q.RGBA;const aq=q.FLOAT;const am=null;for(var av=0;av<2;++av){var ap=f();if(av<F.basefluidTextures.length){q.deleteTexture(F.basefluidTextures[av]);F.basefluidTextures[av]=ap}else{F.basefluidTextures.push(ap)}q.texImage2D(q.TEXTURE_2D,ai,ak,ao,ao,al,at,aq,am);var au=q.createFramebuffer();if(av<F.basefluidFramebuffers.length){q.deleteFramebuffer(F.basefluidFramebuffers[av]);F.basefluidFramebuffers[av]=au}else{F.basefluidFramebuffers.push(au)}q.bindFramebuffer(q.FRAMEBUFFER,au);q.framebufferTexture2D(q.FRAMEBUFFER,q.COLOR_ATTACHMENT0,q.TEXTURE_2D,ap,0)}for(var av=0;av<2;++av){var ah=f();if(av<F.solutesTextures.length){q.deleteTexture(F.solutesTextures[av]);F.solutesTextures[av]=ah}else{F.solutesTextures.push(ah)}q.texImage2D(q.TEXTURE_2D,ai,ak,ao,ao,al,at,aq,am);var ar=q.createFramebuffer();if(av<F.solutesFramebuffers.length){q.deleteFramebuffer(F.solutesFramebuffers[av]);F.solutesFramebuffers[av]=ar}else{F.solutesFramebuffers.push(ar)}q.bindFramebuffer(q.FRAMEBUFFER,ar);q.framebufferTexture2D(q.FRAMEBUFFER,q.COLOR_ATTACHMENT0,q.TEXTURE_2D,ah,0)}}function o(){var aj=0.5*(k.height/M.height-1);var ah=0.5*(k.width/M.width-1);q.bindBuffer(q.ARRAY_BUFFER,Q.bgTexCoordBuffer);var ai=[-ah,1+aj,-ah,-aj,1+ah,1+aj,-ah,-aj,1+ah,-aj,1+ah,1+aj,];q.bufferData(q.ARRAY_BUFFER,new Float32Array(ai),q.STATIC_DRAW)}var r=0.1;var ac=0.1;var T=1.25;var S=0.5*(k.width*(r+1+ac)/(k.height*T)-1);function D(){q.bindBuffer(q.ARRAY_BUFFER,Q.texCoordBuffer);var ah=[-S,-ac,-S,1+r,1+S,-ac,-S,1+r,1+S,1+r,1+S,-ac,];q.bufferData(q.ARRAY_BUFFER,new Float32Array(ah),q.STATIC_DRAW)}function K(ai){var ah=ai[0]*(1+2*S)-S;var aj=ai[1]*(1+ac+r)-ac;return[ah,aj]}function I(ai){Q.program=createProgram(q,Q.vertexShader,Q.fragmentShader);Q.positionAttributeLocation=q.getAttribLocation(Q.program,"a_position");Q.positionBuffer=q.createBuffer();q.bindBuffer(q.ARRAY_BUFFER,Q.positionBuffer);var ah=[-1,-1,-1,1,1,-1,-1,1,1,1,1,-1,];q.bufferData(q.ARRAY_BUFFER,new Float32Array(ah),q.STATIC_DRAW);Q.texCoordAttributeLocation=q.getAttribLocation(Q.program,"a_texCoord");Q.texCoordBuffer=q.createBuffer();D();Q.bgTexCoordAttributeLocation=q.getAttribLocation(Q.program,"a_bgTexCoord");Q.bgTexCoordBuffer=q.createBuffer();o();Q.resolutionUniformLocation=q.getUniformLocation(Q.program,"u_resolution");Q.backgroundImageTintUniformLocation=q.getUniformLocation(Q.program,"u_backgroundImageTint");Q.backgroundImageBrightnessUniformLocation=q.getUniformLocation(Q.program,"u_backgroundImageBrightness");Q.pressureColorUniformLocation=q.getUniformLocation(Q.program,"u_pressureColor");Q.pressureOpacityUniformLocation=q.getUniformLocation(Q.program,"u_pressureOpacity");Q.pressureCutoffUniformLocation=q.getUniformLocation(Q.program,"u_pressureCutoff");Q.pressureIORUniformLocation=q.getUniformLocation(Q.program,"u_pressureIOR");Q.updraftColorUniformLocation=q.getUniformLocation(Q.program,"u_updraftColor");Q.updraftOpacityUniformLocation=q.getUniformLocation(Q.program,"u_updraftOpacity");Q.updraftCutoffUniformLocation=q.getUniformLocation(Q.program,"u_updraftCutoff");Q.updraftIORUniformLocation=q.getUniformLocation(Q.program,"u_updraftIOR");Q.cloudColorUniformLocation=q.getUniformLocation(Q.program,"u_cloudColor");Q.cloudOpacityUniformLocation=q.getUniformLocation(Q.program,"u_cloudOpacity");Q.cloudCutoffUniformLocation=q.getUniformLocation(Q.program,"u_cloudCutoff");Q.cloudIORUniformLocation=q.getUniformLocation(Q.program,"u_cloudIOR");Q.rainColorUniformLocation=q.getUniformLocation(Q.program,"u_rainColor");Q.rainOpacityUniformLocation=q.getUniformLocation(Q.program,"u_rainOpacity");Q.rainCutoffUniformLocation=q.getUniformLocation(Q.program,"u_rainCutoff");Q.rainIORUniformLocation=q.getUniformLocation(Q.program,"u_rainIOR");Q.humidityColorUniformLocation=q.getUniformLocation(Q.program,"u_humidityColor");Q.humidityOpacityUniformLocation=q.getUniformLocation(Q.program,"u_humidityOpacity");Q.humidityCutoffUniformLocation=q.getUniformLocation(Q.program,"u_humidityCutoff");Q.humidityIORUniformLocation=q.getUniformLocation(Q.program,"u_humidityIOR");Q.temperatureColorUniformLocation=q.getUniformLocation(Q.program,"u_temperatureColor");Q.temperatureOpacityUniformLocation=q.getUniformLocation(Q.program,"u_temperatureOpacity");Q.temperatureCutoffUniformLocation=q.getUniformLocation(Q.program,"u_temperatureCutoff");Q.temperatureIORUniformLocation=q.getUniformLocation(Q.program,"u_temperatureIOR");Q.humidityTemperatureColorUniformLocation=q.getUniformLocation(Q.program,"u_humidityTemperatureColor");Q.humidityTemperatureOpacityUniformLocation=q.getUniformLocation(Q.program,"u_humidityTemperatureOpacity");Q.humidityTemperatureCutoffUniformLocation=q.getUniformLocation(Q.program,"u_humidityTemperatureCutoff");Q.humidityTemperatureIORUniformLocation=q.getUniformLocation(Q.program,"u_humidityTemperatureIOR");Q.relativeTemperatureColorUniformLocation=q.getUniformLocation(Q.program,"u_relativeTemperatureColor");Q.relativeTemperatureOpacityUniformLocation=q.getUniformLocation(Q.program,"u_relativeTemperatureOpacity");Q.relativeTemperatureCutoffUniformLocation=q.getUniformLocation(Q.program,"u_relativeTemperatureCutoff");Q.relativeTemperatureIORUniformLocation=q.getUniformLocation(Q.program,"u_relativeTemperatureIOR");Q.updraftTemperatureColorUniformLocation=q.getUniformLocation(Q.program,"u_updraftTemperatureColor");Q.updraftTemperatureOpacityUniformLocation=q.getUniformLocation(Q.program,"u_updraftTemperatureOpacity");Q.updraftTemperatureCutoffUniformLocation=q.getUniformLocation(Q.program,"u_updraftTemperatureCutoff");Q.updraftTemperatureIORUniformLocation=q.getUniformLocation(Q.program,"u_updraftTemperatureIOR");Q.globalStabilityUniformLocation=q.getUniformLocation(Q.program,"u_globalStability");Q.inversionAltitudeUniformLocation=q.getUniformLocation(Q.program,"u_inversionAltitude");Q.inversionTemperatureUniformLocation=q.getUniformLocation(Q.program,"u_inversionTemperature");Q.groundInversionDepthUniformLocation=q.getUniformLocation(Q.program,"u_groundInversionDepth");Q.groundInversionTemperatureUniformLocation=q.getUniformLocation(Q.program,"u_groundInversionTemperature");Q.u_basefluidLocation=q.getUniformLocation(Q.program,"u_basefluid");Q.u_solutesLocation=q.getUniformLocation(Q.program,"u_solutes");Q.u_backgroundLocation=q.getUniformLocation(Q.program,"u_background");if(Q.backgroundImageTexture){q.deleteTexture(Q.backgroundImageTexture)}Q.backgroundImageTexture=f();q.texParameteri(q.TEXTURE_2D,q.TEXTURE_MAG_FILTER,q.LINEAR);q.texParameteri(q.TEXTURE_2D,q.TEXTURE_WRAP_S,q.REPEAT);q.texParameteri(q.TEXTURE_2D,q.TEXTURE_WRAP_T,q.REPEAT);q.texImage2D(q.TEXTURE_2D,0,q.RGBA,q.RGBA,q.UNSIGNED_BYTE,M);if(Q.transferBasefluidTexture){q.deleteTexture(Q.transferBasefluidTexture)}Q.transferBasefluidTexture=f();if(l){q.texParameteri(q.TEXTURE_2D,q.TEXTURE_MAG_FILTER,q.LINEAR)}q.texImage2D(q.TEXTURE_2D,0,q.RGBA32F,b.resolution,b.resolution,0,q.RGBA,q.FLOAT,null);if(Q.transferBasefluidFramebuffer){q.deleteFramebuffer(Q.transferBasefluidFramebuffer)}Q.transferBasefluidFramebuffer=q.createFramebuffer();q.bindFramebuffer(q.FRAMEBUFFER,Q.transferBasefluidFramebuffer);q.framebufferTexture2D(q.FRAMEBUFFER,q.COLOR_ATTACHMENT0,q.TEXTURE_2D,Q.transferBasefluidTexture,0);if(Q.transferSolutesTexture){q.deleteTexture(Q.transferSolutesTexture)}Q.transferSolutesTexture=f();if(l){q.texParameteri(q.TEXTURE_2D,q.TEXTURE_MAG_FILTER,q.LINEAR)}q.texImage2D(q.TEXTURE_2D,0,q.RGBA32F,b.resolution,b.resolution,0,q.RGBA,q.FLOAT,null);if(Q.transferSolutesFramebuffer){q.deleteFramebuffer(Q.transferSolutesFramebuffer)}Q.transferSolutesFramebuffer=q.createFramebuffer();q.bindFramebuffer(q.FRAMEBUFFER,Q.transferSolutesFramebuffer);q.framebufferTexture2D(q.FRAMEBUFFER,q.COLOR_ATTACHMENT0,q.TEXTURE_2D,Q.transferSolutesTexture,0)}var N=[];function u(ah){N[ah-1]=true;if(N.every(function(ai){return ai})){s()}}var G=["./images/aileron-grey.png","./images/squares/squares_00.png","./images/squares/squares_01.png","./images/squares/squares_02.png","./images/squares/squares_03.png","./images/hexes/hexes_00.png","./images/hexes/hexes_01.png","./images/aileron.png","./images/aileron-inv.png",];var M=new Image();function J(){if(Q.backgroundImageTexture){M.onload=function(){q.bindTexture(q.TEXTURE_2D,Q.backgroundImageTexture);q.texImage2D(q.TEXTURE_2D,0,q.RGBA,q.RGBA,q.UNSIGNED_BYTE,M);o();e()};M.src=G[b.backgroundImage]}}var a=new XMLHttpRequest();var ae=N.push(false);a.open("GET","shaders/weathersolver.vert",true);a.onload=function(ah){if(this.status==200){F.vertexShader=createShader(q,q.VERTEX_SHADER,a.response);u(ae)}};a.send(null);var Z=new XMLHttpRequest();var W=N.push(false);Z.open("GET","shaders/weathersolver.frag",true);Z.onload=function(ah){if(this.status==200){F.fragmentShader=createShader(q,q.FRAGMENT_SHADER,Z.response);u(W)}};Z.send(null);var ab=new XMLHttpRequest();var x=N.push(false);ab.open("GET","shaders/weatherrenderer.vert",true);ab.onload=function(ah){if(this.status==200){Q.vertexShader=createShader(q,q.VERTEX_SHADER,ab.response);u(x)}};ab.send(null);var aa=new XMLHttpRequest();var w=N.push(false);aa.open("GET","shaders/weatherrenderer.frag",true);aa.onload=function(ah){if(this.status==200){Q.fragmentShader=createShader(q,q.FRAGMENT_SHADER,aa.response);u(w)}};aa.send(null);function j(aj){V=new dat.GUI({load:aj});V.remember(b);var ai=V.addFolder("Simulation Params");var an=ai.addFolder("Stability");an.add(b,"globalWind").min(-1).max(1).step(0.01);an.add(b,"globalStability").min(0).max(0.5).step(0.01);an.add(b,"inversionAltitude").min(0.5).max(1).step(0.01);an.add(b,"inversionTemperature").min(0.5).max(1.5).step(0.01);an.add(b,"groundInversionDepth").min(0).max(0.5).step(0.01);an.add(b,"groundInversionTemperature").min(0).max(0.5).step(0.01);an.add(b,"heatDisipationRate").min(0).max(0.005).step(0.0001);an.add(b,"buoyancyFactor").min(0).max(0.1).step(0.001);an.add(b,"rainFallingFactor").min(0).max(0.1).step(0.001);var al=ai.addFolder("Water Content");al.add(b,"temperatureDiffusion").min(0).max(0.1).step(0.01);al.add(b,"humidityDiffusion").min(0).max(0.1).step(0.01);al.add(b,"condensationFactor").min(0).max(1).step(0.01);al.add(b,"mistDiffusion").min(0).max(0.1).step(0.01);al.add(b,"mistToRainFactor").min(0).max(0.01).step(0.0001);al.add(b,"rainFallDiffusion").min(0).max(1).step(0.001);al.add(b,"rainEvaporation").min(0).max(0.001).step(0.00001);al.add(b,"initialHumidity").min(0).max(1).step(0.01);al.add(b,"condensationLevel").min(0).max(1).step(0.01);al.add(b,"latentHeat").min(0).max(5).step(0.1);var ah=V.addFolder("Solver Settings");ah.add(b,"resolution",[64,128,256,512,1024,2048,4096]).onChange(X);ah.add(b,"pressureSolveSteps").min(1).max(30).step(1);ah.add(b,"diffusion").min(0).max(1).step(0.01);var aw=V.addFolder("Display Options");aw.add(b,"displayOutline").onChange(e);aw.add(b,"backgroundImage",[0,1,2,3,4,5,6,7,8]).onChange(J);aw.addColor(b,"backgroundImageTint").onChange(e);aw.add(b,"backgroundImageBrightness").min(-1).max(1).step(0.01).onChange(e);var av=aw.addFolder("Pressure");av.addColor(b,"pressureColor").onChange(e);av.add(b,"pressureOpacity").min(0).max(100000).step(100).onChange(e);av.add(b,"pressureCutoff").min(0).max(0.01).step(0.00001).onChange(e);av.add(b,"pressureIOR").min(-100).max(100).step(1).onChange(e);var au=aw.addFolder("Updraft");au.addColor(b,"updraftColor").onChange(e);au.add(b,"updraftOpacity").min(0).max(15).step(0.01).onChange(e);au.add(b,"updraftCutoff").min(0).max(1).step(0.001).onChange(e);au.add(b,"updraftIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var at=aw.addFolder("Cloud");at.addColor(b,"cloudColor").onChange(e);at.add(b,"cloudOpacity").min(0).max(70).step(0.1).onChange(e);at.add(b,"cloudCutoff").min(0).max(1).step(0.001).onChange(e);at.add(b,"cloudIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var ar=aw.addFolder("Rain");ar.addColor(b,"rainColor").onChange(e);ar.add(b,"rainOpacity").min(0).max(30).step(0.1).onChange(e);ar.add(b,"rainCutoff").min(0).max(1).step(0.001).onChange(e);ar.add(b,"rainIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var aq=aw.addFolder("Humidity");aq.addColor(b,"humidityColor").onChange(e);aq.add(b,"humidityOpacity").min(0).max(15).step(0.1).onChange(e);aq.add(b,"humidityCutoff").min(0).max(1).step(0.001).onChange(e);aq.add(b,"humidityIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var ap=aw.addFolder("Temperature");ap.addColor(b,"temperatureColor").onChange(e);ap.add(b,"temperatureOpacity").min(0).max(15).step(0.1).onChange(e);ap.add(b,"temperatureCutoff").min(0).max(1).step(0.001).onChange(e);ap.add(b,"temperatureIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var ao=aw.addFolder("Humidity Temperature");ao.addColor(b,"humidityTemperatureColor").onChange(e);ao.add(b,"humidityTemperatureOpacity").min(0).max(15).step(0.01).onChange(e);ao.add(b,"humidityTemperatureCutoff").min(0).max(1).step(0.001).onChange(e);ao.add(b,"humidityTemperatureIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var am=aw.addFolder("Relative Temperature");am.addColor(b,"relativeTemperatureColor").onChange(e);am.add(b,"relativeTemperatureOpacity").min(0).max(15).step(0.01).onChange(e);am.add(b,"relativeTemperatureCutoff").min(0).max(1).step(0.001).onChange(e);am.add(b,"relativeTemperatureIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var ak=aw.addFolder("Updraft Temperature");ak.addColor(b,"updraftTemperatureColor").onChange(e);ak.add(b,"updraftTemperatureOpacity").min(0).max(15).step(0.01).onChange(e);ak.add(b,"updraftTemperatureCutoff").min(0).max(1).step(0.001).onChange(e);ak.add(b,"updraftTemperatureIOR").min(-0.1).max(0.1).step(0.001).onChange(e);V.add(b,"runSimulation");V.add(b,"stopSimulation");V.add(b,"stepSimulation");V.add(b,"basefluid").listen();V.add(b,"solutes").listen()}var af=new XMLHttpRequest();var z=N.push(false);af.open("GET","presets.json",true);af.onload=function(ai){if(this.status==200){j(JSON.parse(af.response));var ah=N.push(false);M.onload=function(){u(ah)};M.src=G[b.backgroundImage];u(z)}};af.send(null);function ag(aj){var ai;var ah;if(aj==null){ai=q.canvas.width;ah=q.canvas.height}else{ai=b.resolution;ah=b.resolution}q.bindFramebuffer(q.FRAMEBUFFER,aj);q.viewport(0,0,parseFloat(ai),parseFloat(ah))}var E=0;var O=1;var H=0;var R=1;function B(){H=(H==0)?1:0;R=(R==0)?1:0}function ad(){E=(E==0)?1:0;O=(O==0)?1:0}function y(an,am){q.useProgram(F.program);q.uniform1i(F.u_basefluidLocation,0);q.uniform1i(F.u_solutesLocation,1);q.uniform1i(F.u_groundLocation,2);q.activeTexture(q.TEXTURE0);q.bindTexture(q.TEXTURE_2D,F.basefluidTextures[E]);q.activeTexture(q.TEXTURE1);q.bindTexture(q.TEXTURE_2D,F.solutesTextures[H]);q.activeTexture(q.TEXTURE2);d();ag(an);q.uniform1f(F.resolutionUniformLocation,b.resolution);q.enableVertexAttribArray(F.positionAttributeLocation);q.bindBuffer(q.ARRAY_BUFFER,F.positionBuffer);var ap=2;var al=q.FLOAT;var aj=false;var ah=0;var ai=0;q.vertexAttribPointer(F.positionAttributeLocation,ap,al,aj,ah,ai);q.enableVertexAttribArray(F.texCoordAttributeLocation);q.bindBuffer(q.ARRAY_BUFFER,F.texCoordBuffer);var ap=2;var al=q.FLOAT;var aj=false;var ah=0;var ai=0;q.vertexAttribPointer(F.texCoordAttributeLocation,ap,al,aj,ah,ai);q.uniform1i(F.calcFunctionUniformLocation,am);q.uniform1f(F.diffusionUniformLocation,b.diffusion);q.uniform1f(F.buoyancyFactorUniformLocation,b.buoyancyFactor);q.uniform1f(F.rainFallingFactorUniformLocation,b.rainFallingFactor);q.uniform1f(F.globalWindUniformLocation,b.globalWind);q.uniform1f(F.globalStabilityUniformLocation,b.globalStability);q.uniform1f(F.inversionAltitudeUniformLocation,b.inversionAltitude);q.uniform1f(F.inversionTemperatureUniformLocation,b.inversionTemperature);q.uniform1f(F.groundInversionDepthUniformLocation,b.groundInversionDepth);q.uniform1f(F.groundInversionTemperatureUniformLocation,b.groundInversionTemperature);q.uniform1f(F.heatDisipationRateUniformLocation,b.heatDisipationRate);q.uniform1f(F.temperatureDiffusionUniformLocation,b.temperatureDiffusion);q.uniform1f(F.humidityDiffusionUniformLocation,b.humidityDiffusion);q.uniform1f(F.condensationFactorUniformLocation,b.condensationFactor);q.uniform1f(F.mistDiffusionUniformLocation,b.mistDiffusion);q.uniform1f(F.mistToRainFactorUniformLocation,b.mistToRainFactor);q.uniform1f(F.rainFallDiffusionUniformLocation,b.rainFallDiffusion);q.uniform1f(F.rainEvaporationUniformLocation,b.rainEvaporation);q.uniform1f(F.initialHumidityUniformLocation,b.initialHumidity);q.uniform1f(F.condensationLevelUniformLocation,b.condensationLevel);q.uniform1f(F.latentHeatUniformLocation,b.latentHeat);var ao=q.TRIANGLES;var ai=0;var ak=6;q.drawArrays(ao,ai,ak)}function A(){if(!p&&Q.transferBasefluidFramebuffer&&Q.transferSolutesFramebuffer){var ah=K(t);q.bindFramebuffer(q.FRAMEBUFFER,Q.transferBasefluidFramebuffer);q.readPixels(ah[0]*m,ah[1]*m,1,1,q.RGBA,q.FLOAT,g);q.bindFramebuffer(q.FRAMEBUFFER,Q.transferSolutesFramebuffer);q.readPixels(ah[0]*m,ah[1]*m,1,1,q.RGBA,q.FLOAT,v)}b.basefluid=" vx: "+g[0].toFixed(2)+", vy: "+g[1].toFixed(2)+", t: "+v[0].toFixed(3);b.solutes=" h: "+v[2].toFixed(3)+", m: "+v[3].toFixed(3)+", r: "+v[1].toFixed(3)}function n(){var aj=K(t);y(Q.transferBasefluidFramebuffer,0);q.readPixels(aj[0]*m,aj[1]*m,1,1,q.RGBA,q.FLOAT,g);y(Q.transferSolutesFramebuffer,1);q.readPixels(aj[0]*m,aj[1]*m,1,1,q.RGBA,q.FLOAT,v);A();q.useProgram(Q.program);q.uniform1i(Q.u_basefluidLocation,0);q.uniform1i(Q.u_solutesLocation,1);q.uniform1i(Q.u_backgroundLocation,2);q.activeTexture(q.TEXTURE0);q.bindTexture(q.TEXTURE_2D,Q.transferBasefluidTexture);q.activeTexture(q.TEXTURE1);q.bindTexture(q.TEXTURE_2D,Q.transferSolutesTexture);q.activeTexture(q.TEXTURE2);q.bindTexture(q.TEXTURE_2D,Q.backgroundImageTexture);ag(null);q.uniform2f(Q.resolutionUniformLocation,b.resolution,b.resolution);q.enableVertexAttribArray(Q.positionAttributeLocation);q.bindBuffer(q.ARRAY_BUFFER,Q.positionBuffer);q.vertexAttribPointer(Q.positionAttributeLocation,2,q.FLOAT,false,0,0);q.enableVertexAttribArray(Q.texCoordAttributeLocation);q.bindBuffer(q.ARRAY_BUFFER,Q.texCoordBuffer);q.vertexAttribPointer(Q.texCoordAttributeLocation,2,q.FLOAT,false,0,0);q.enableVertexAttribArray(Q.bgTexCoordAttributeLocation);q.bindBuffer(q.ARRAY_BUFFER,Q.bgTexCoordBuffer);q.vertexAttribPointer(Q.bgTexCoordAttributeLocation,2,q.FLOAT,false,0,0);q.uniform3f(Q.backgroundImageTintUniformLocation,b.backgroundImageTint[0]/256,b.backgroundImageTint[1]/256,b.backgroundImageTint[2]/256);q.uniform1f(Q.backgroundImageBrightnessUniformLocation,b.backgroundImageBrightness);q.uniform3f(Q.pressureColorUniformLocation,b.pressureColor[0]/256,b.pressureColor[1]/256,b.pressureColor[2]/256);q.uniform1f(Q.pressureOpacityUniformLocation,b.pressureOpacity);q.uniform1f(Q.pressureCutoffUniformLocation,b.pressureCutoff);q.uniform1f(Q.pressureIORUniformLocation,b.pressureIOR);q.uniform3f(Q.updraftColorUniformLocation,b.updraftColor[0]/256,b.updraftColor[1]/256,b.updraftColor[2]/256);q.uniform1f(Q.updraftOpacityUniformLocation,b.updraftOpacity);q.uniform1f(Q.updraftCutoffUniformLocation,b.updraftCutoff);q.uniform1f(Q.updraftIORUniformLocation,b.updraftIOR);q.uniform3f(Q.cloudColorUniformLocation,b.cloudColor[0]/256,b.cloudColor[1]/256,b.cloudColor[2]/256);q.uniform1f(Q.cloudOpacityUniformLocation,b.cloudOpacity);q.uniform1f(Q.cloudCutoffUniformLocation,b.cloudCutoff);q.uniform1f(Q.cloudIORUniformLocation,b.cloudIOR);q.uniform3f(Q.rainColorUniformLocation,b.rainColor[0]/256,b.rainColor[1]/256,b.rainColor[2]/256);q.uniform1f(Q.rainOpacityUniformLocation,b.rainOpacity);q.uniform1f(Q.rainCutoffUniformLocation,b.rainCutoff);q.uniform1f(Q.rainIORUniformLocation,b.rainIOR);q.uniform3f(Q.humidityColorUniformLocation,b.humidityColor[0]/256,b.humidityColor[1]/256,b.humidityColor[2]/256);q.uniform1f(Q.humidityOpacityUniformLocation,b.humidityOpacity);q.uniform1f(Q.humidityCutoffUniformLocation,b.humidityCutoff);q.uniform1f(Q.humidityIORUniformLocation,b.humidityIOR);q.uniform3f(Q.temperatureColorUniformLocation,b.temperatureColor[0]/256,b.temperatureColor[1]/256,b.temperatureColor[2]/256);q.uniform1f(Q.temperatureOpacityUniformLocation,b.temperatureOpacity);q.uniform1f(Q.temperatureCutoffUniformLocation,b.temperatureCutoff);q.uniform1f(Q.temperatureIORUniformLocation,b.temperatureIOR);q.uniform3f(Q.humidityTemperatureColorUniformLocation,b.humidityTemperatureColor[0]/256,b.humidityTemperatureColor[1]/256,b.humidityTemperatureColor[2]/256);q.uniform1f(Q.humidityTemperatureOpacityUniformLocation,b.humidityTemperatureOpacity);q.uniform1f(Q.humidityTemperatureCutoffUniformLocation,b.humidityTemperatureCutoff);q.uniform1f(Q.humidityTemperatureIORUniformLocation,b.humidityTemperatureIOR);q.uniform3f(Q.relativeTemperatureColorUniformLocation,b.relativeTemperatureColor[0]/256,b.relativeTemperatureColor[1]/256,b.relativeTemperatureColor[2]/256);q.uniform1f(Q.relativeTemperatureOpacityUniformLocation,b.relativeTemperatureOpacity);q.uniform1f(Q.relativeTemperatureCutoffUniformLocation,b.relativeTemperatureCutoff);q.uniform1f(Q.relativeTemperatureIORUniformLocation,b.relativeTemperatureIOR);q.uniform3f(Q.updraftTemperatureColorUniformLocation,b.updraftTemperatureColor[0]/256,b.updraftTemperatureColor[1]/256,b.updraftTemperatureColor[2]/256);q.uniform1f(Q.updraftTemperatureOpacityUniformLocation,b.updraftTemperatureOpacity);q.uniform1f(Q.updraftTemperatureCutoffUniformLocation,b.updraftTemperatureCutoff);q.uniform1f(Q.updraftTemperatureIORUniformLocation,b.updraftTemperatureIOR);q.uniform1f(Q.globalStabilityUniformLocation,b.globalStability);q.uniform1f(Q.inversionAltitudeUniformLocation,b.inversionAltitude);q.uniform1f(Q.inversionTemperatureUniformLocation,b.inversionTemperature);q.uniform1f(Q.groundInversionDepthUniformLocation,b.groundInversionDepth);q.uniform1f(Q.groundInversionTemperatureUniformLocation,b.groundInversionTemperature);var ah=q.TRIANGLES;var ak=0;var ai=6;q.drawArrays(ah,ak,ai)}var e=function(){if(b.displayOutline){k.style.border="1px  solid red"}else{k.style.border="none"}if(!p){n()}};var c=function(ah){y(F.basefluidFramebuffers[O],4);ad();for(var ai=1;ai<b.pressureSolveSteps;ai+=1){y(F.basefluidFramebuffers[O],5);ad()}y(F.basefluidFramebuffers[O],6);ad()};function i(ah,ai,aj){h[ah*4+0]=ai;h[ah*4+2]=aj}L=function(){i(2,70,0);i(3,70,10);i(4,170,10);i(5,70,10);i(8,170,10);i(9,70,0);i(12,0,50);i(13,0,50);y(F.basefluidFramebuffers[O],9);ad();y(F.solutesFramebuffers[R],10);B();y(F.basefluidFramebuffers[O],2);ad();y(F.solutesFramebuffers[R],7);B();c();y(F.basefluidFramebuffers[O],3);ad();y(F.solutesFramebuffers[R],8);B();c();n();if(p){requestAnimationFrame(L)}};var m=256;function X(ah){if(ah!=m){s(true);m=ah}}};