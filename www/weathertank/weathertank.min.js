/************************************************************************

   WeatherTank - WebGL boundary layer weather simulation.

   Copyright (C) 2017, Davor Bokun <bokundavor@gmail.com>

   This program is free software: you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program.  If not, see <http://www.gnu.org/licenses/>.

*************************************************************************/

function createShader(e,a,c){var b=e.createShader(a);e.shaderSource(b,c);e.compileShader(b);var d=e.getShaderParameter(b,e.COMPILE_STATUS);if(d){return b}console.log(e.getShaderInfoLog(b));console.log(c);e.deleteShader(b)}function createProgram(e,d,a){var b=e.createProgram();e.attachShader(b,d);e.attachShader(b,a);e.linkProgram(b);var c=e.getProgramParameter(b,e.LINK_STATUS);if(c){return b}console.log(e.getProgramInfoLog(b));e.deleteProgram(b)}window.onload=function(){var k=document.getElementById("simcanvas");k.width=k.clientWidth;k.height=k.clientHeight;var p=k.getContext("webgl2",{premultipliedAlpha:false});ext=p.getExtension("EXT_color_buffer_float");if(!ext){console.log("need EXT_color_buffer_float");return}ext=p.getExtension("OES_texture_float_linear");if(!ext){console.log("need OES_texture_float_linear");return}var s=new Float32Array(2);var g=new Float32Array(4);var u=new Float32Array(4);k.onmousemove=function(af){s[0]=af.clientX/k.width;s[1]=1-af.clientY/k.height};var T=null;var S=function(){this.program=null;this.vertexShader=null;this.fragmentShader=null;this.positionAttributeLocation=null;this.positionBuffer=null;this.texCoordAttributeLocation=null;this.texCoordBuffer=null;this.bgTexCoordAttributeLocation=null;this.bgTexCoordBuffer=null;this.resolutionUniformLocation=null;this.backgroundImageTintUniformLocation=null;this.backgroundImageBrightnessUniformLocation=null;this.pressureColorUniformLocation=null;this.pressureOpacityUniformLocation=null;this.pressureCutoffUniformLocation=null;this.pressureIORUniformLocation=null;this.updraftColorUniformLocation=null;this.updraftOpacityUniformLocation=null;this.updraftCutoffUniformLocation=null;this.updraftIORUniformLocation=null;this.cloudColorUniformLocation=null;this.cloudOpacityUniformLocation=null;this.cloudCutoffUniformLocation=null;this.cloudIORUniformLocation=null;this.rainColorUniformLocation=null;this.rainOpacityUniformLocation=null;this.rainCutoffUniformLocation=null;this.rainIORUniformLocation=null;this.humidityColorUniformLocation=null;this.humidityOpacityUniformLocation=null;this.humidityCutoffUniformLocation=null;this.humidityIORUniformLocation=null;this.temperatureColorUniformLocation=null;this.temperatureOpacityUniformLocation=null;this.temperatureCutoffUniformLocation=null;this.temperatureIORUniformLocation=null;this.humidityTemperatureColorUniformLocation=null;this.humidityTemperatureOpacityUniformLocation=null;this.humidityTemperatureCutoffUniformLocation=null;this.humidityTemperatureIORUniformLocation=null;this.relativeTemperatureColorUniformLocation=null;this.relativeTemperatureOpacityUniformLocation=null;this.relativeTemperatureCutoffUniformLocation=null;this.relativeTemperatureIORUniformLocation=null;this.updraftTemperatureColorUniformLocation=null;this.updraftTemperatureOpacityUniformLocation=null;this.updraftTemperatureCutoffUniformLocation=null;this.updraftTemperatureIORUniformLocation=null;this.globalStabilityUniformLocation=null;this.inversionAltitudeUniformLocation=null;this.inversionTemperatureUniformLocation=null;this.groundInversionDepthUniformLocation=null;this.groundInversionTemperatureUniformLocation=null;this.backgroundImageTexture=null;this.logoImageTexture=null;this.transferBasefluidTexture=null;this.transferBasefluidFramebuffer=null;this.transferSolutesTexture=null;this.transferSolutesFramebuffer=null;this.u_basefluidLocation=null;this.u_solutesLocation=null;this.u_backgroundLocation=null};var N=function(){this.program=null;this.vertexShader=null;this.fragmentShader=null;this.positionAttributeLocation=null;this.positionBuffer=null;this.texCoordAttributeLocation=null;this.texCoordBuffer=null;this.calcFunctionUniformLocation=null;this.resolutionUniformLocation=null;this.diffusionUniformLocation=null;this.buoyancyFactorUniformLocation=null;this.rainFallingFactorUniformLocation=null;this.globalWindUniformLocation=null;this.globalStabilityUniformLocation=null;this.inversionAltitudeUniformLocation=null;this.inversionTemperatureUniformLocation=null;this.groundInversionDepthUniformLocation=null;this.groundInversionTemperatureUniformLocation=null;this.heatDisipationRateUniformLocation=null;this.temperatureDiffusionUniformLocation=null;this.humidityDiffusionUniformLocation=null;this.condensationFactorUniformLocation=null;this.mistToRainFactorUniformLocation=null;this.rainFallDiffusionUniformLocation=null;this.mistDiffusionUniformLocation=null;this.rainEvaporationUniformLocation=null;this.initialHumidityUniformLocation=null;this.condensationLevelUniformLocation=null;this.latentHeatUniformLocation=null;this.groundTexture=null;this.basefluidTextures=[];this.basefluidFramebuffers=[];this.solutesTextures=[];this.solutesFramebuffers=[];this.u_basefluidLocation=null;this.u_solutesLocation=null;this.u_groundLocation=null};var O=new S();var D=new N();var h=new Uint8Array(16*4);function d(){p.bindTexture(p.TEXTURE_2D,D.groundTexture);p.texImage2D(p.TEXTURE_2D,0,p.RGBA,16,1,0,p.RGBA,p.UNSIGNED_BYTE,h)}function f(){var af=p.createTexture();p.bindTexture(p.TEXTURE_2D,af);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_S,p.REPEAT);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,p.CLAMP_TO_EDGE);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,p.NEAREST);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.NEAREST);return af}var o=false;var J;var A=function(){this.buoyancyFactor=0.01;this.rainFallingFactor=0.01;this.globalWind=0.05;this.globalStability=0.02;this.inversionAltitude=0.9;this.inversionTemperature=0.8;this.groundInversionDepth=0.1;this.groundInversionTemperature=0.3;this.heatDisipationRate=0.0001;this.temperatureDiffusion=0.01;this.humidityDiffusion=0.01;this.condensationFactor=1;this.mistDiffusion=0.01;this.mistToRainFactor=0.001;this.rainFallDiffusion=0.2;this.rainEvaporation=0.00008;this.initialHumidity=0;this.condensationLevel=0.6;this.latentHeat=1;this.stepSize=0.1;this.resolution=256;this.pressureSolveSteps=10;this.diffusion=0.01;this.displayOutline=false;this.backgroundImage=-1;this.backgroundImageTint=[255,255,255];this.backgroundImageBrightness=0;this.pressureColor=[255,0,0];this.pressureOpacity=0;this.pressureCutoff=0;this.pressureIOR=0;this.updraftColor=[255,0,0];this.updraftOpacity=0;this.updraftCutoff=0;this.updraftIOR=0;this.cloudColor=[255,255,255];this.cloudOpacity=1;this.cloudCutoff=0;this.cloudIOR=0;this.rainColor=[120,120,155];this.rainOpacity=1;this.rainCutoff=0;this.rainIOR=0;this.humidityColor=[0,0,255];this.humidityOpacity=1;this.humidityCutoff=0;this.humidityIOR=0;this.temperatureColor=[255,0,0];this.temperatureOpacity=0;this.temperatureCutoff=0;this.temperatureIOR=0;this.humidityTemperatureColor=[255,0,0];this.humidityTemperatureOpacity=0;this.humidityTemperatureCutoff=0;this.humidityTemperatureIOR=0;this.relativeTemperatureColor=[255,0,0];this.relativeTemperatureOpacity=0;this.relativeTemperatureCutoff=0;this.relativeTemperatureIOR=0;this.updraftTemperatureColor=[255,0,0];this.updraftTemperatureOpacity=0;this.updraftTemperatureCutoff=0;this.updraftTemperatureIOR=0;this.runSimulation=function(){if(!o){console.log("START");o=true;requestAnimationFrame(J)}};this.stopSimulation=function(){if(o){o=false;console.log("STOP")}else{console.log("RESET");r()}};this.stepSimulation=function(){if(!o){J();console.log("STEP")}};this.basefluid="";this.solutes=""};var b=new A();function r(){k.width=k.clientWidth;k.height=k.clientHeight;W();G();e();F=0;P=1;C=0;M=1;x(D.solutesFramebuffers[P],11);z();m();if(window.location.hash!="#nostart"){b.runSimulation()}}function W(){D.program=createProgram(p,D.vertexShader,D.fragmentShader);D.positionAttributeLocation=p.getAttribLocation(D.program,"a_position");D.positionBuffer=p.createBuffer();p.bindBuffer(p.ARRAY_BUFFER,D.positionBuffer);var al=[-1,-1,-1,1,1,-1,-1,1,1,1,1,-1,];p.bufferData(p.ARRAY_BUFFER,new Float32Array(al),p.STATIC_DRAW);D.texCoordAttributeLocation=p.getAttribLocation(D.program,"a_texCoord");D.texCoordBuffer=p.createBuffer();p.bindBuffer(p.ARRAY_BUFFER,D.texCoordBuffer);var ah=[0,0,0,1,1,0,0,1,1,1,1,0,];p.bufferData(p.ARRAY_BUFFER,new Float32Array(ah),p.STATIC_DRAW);D.calcFunctionUniformLocation=p.getUniformLocation(D.program,"u_calcFunction");D.resolutionUniformLocation=p.getUniformLocation(D.program,"u_resolution");D.diffusionUniformLocation=p.getUniformLocation(D.program,"u_diffusion");D.buoyancyFactorUniformLocation=p.getUniformLocation(D.program,"u_buoyancyFactor");D.rainFallingFactorUniformLocation=p.getUniformLocation(D.program,"u_rainFallingFactor");D.globalWindUniformLocation=p.getUniformLocation(D.program,"u_globalWind");D.globalStabilityUniformLocation=p.getUniformLocation(D.program,"u_globalStability");D.inversionAltitudeUniformLocation=p.getUniformLocation(D.program,"u_inversionAltitude");D.inversionTemperatureUniformLocation=p.getUniformLocation(D.program,"u_inversionTemperature");D.groundInversionDepthUniformLocation=p.getUniformLocation(D.program,"u_groundInversionDepth");D.groundInversionTemperatureUniformLocation=p.getUniformLocation(D.program,"u_groundInversionTemperature");D.heatDisipationRateUniformLocation=p.getUniformLocation(D.program,"u_heatDisipationRate");D.temperatureDiffusionUniformLocation=p.getUniformLocation(D.program,"u_temperatureDiffusion");D.humidityDiffusionUniformLocation=p.getUniformLocation(D.program,"u_humidityDiffusion");D.condensationFactorUniformLocation=p.getUniformLocation(D.program,"u_condensationFactor");D.mistDiffusionUniformLocation=p.getUniformLocation(D.program,"u_mistDiffusion");D.mistToRainFactorUniformLocation=p.getUniformLocation(D.program,"u_mistToRainFactor");D.rainFallDiffusionUniformLocation=p.getUniformLocation(D.program,"u_rainFallDiffusion");D.rainEvaporationUniformLocation=p.getUniformLocation(D.program,"u_rainEvaporation");D.initialHumidityUniformLocation=p.getUniformLocation(D.program,"u_initialHumidity");D.condensationLevelUniformLocation=p.getUniformLocation(D.program,"u_condensationLevel");D.latentHeatUniformLocation=p.getUniformLocation(D.program,"u_latentHeat");D.u_basefluidLocation=p.getUniformLocation(D.program,"u_basefluid");D.u_solutesLocation=p.getUniformLocation(D.program,"u_solutes");D.u_groundLocation=p.getUniformLocation(D.program,"u_ground");if(D.groundTexture){p.deleteTexture(D.groundTexture)}D.groundTexture=f();p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.LINEAR);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,p.REPEAT);d();const ag=0;const ai=p.RGBA32F;var am=b.resolution;const aj=0;const aq=p.RGBA;const ao=p.FLOAT;const ak=null;for(var at=0;at<2;++at){var an=f();if(at<D.basefluidTextures.length){p.deleteTexture(D.basefluidTextures[at]);D.basefluidTextures[at]=an}else{D.basefluidTextures.push(an)}p.texImage2D(p.TEXTURE_2D,ag,ai,am,am,aj,aq,ao,ak);var ar=p.createFramebuffer();if(at<D.basefluidFramebuffers.length){p.deleteFramebuffer(D.basefluidFramebuffers[at]);D.basefluidFramebuffers[at]=ar}else{D.basefluidFramebuffers.push(ar)}p.bindFramebuffer(p.FRAMEBUFFER,ar);p.framebufferTexture2D(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,p.TEXTURE_2D,an,0)}for(var at=0;at<2;++at){var af=f();if(at<D.solutesTextures.length){p.deleteTexture(D.solutesTextures[at]);D.solutesTextures[at]=af}else{D.solutesTextures.push(af)}p.texImage2D(p.TEXTURE_2D,ag,ai,am,am,aj,aq,ao,ak);var ap=p.createFramebuffer();if(at<D.solutesFramebuffers.length){p.deleteFramebuffer(D.solutesFramebuffers[at]);D.solutesFramebuffers[at]=ap}else{D.solutesFramebuffers.push(ap)}p.bindFramebuffer(p.FRAMEBUFFER,ap);p.framebufferTexture2D(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,p.TEXTURE_2D,af,0)}}function n(){var ah=0.5*(k.height/K.height-1);var af=0.5*(k.width/K.width-1);p.bindBuffer(p.ARRAY_BUFFER,O.bgTexCoordBuffer);var ag=[-af,1+ah,-af,-ah,1+af,1+ah,-af,-ah,1+af,-ah,1+af,1+ah,];p.bufferData(p.ARRAY_BUFFER,new Float32Array(ag),p.STATIC_DRAW)}var q=0.1;var aa=0.1;var R=1.25;var Q=0.5*(k.width*(q+1+aa)/(k.height*R)-1);function B(){p.bindBuffer(p.ARRAY_BUFFER,O.texCoordBuffer);var af=[-Q,-aa,-Q,1+q,1+Q,-aa,-Q,1+q,1+Q,1+q,1+Q,-aa,];p.bufferData(p.ARRAY_BUFFER,new Float32Array(af),p.STATIC_DRAW)}function I(ag){var af=ag[0]*(1+2*Q)-Q;var ah=ag[1]*(1+aa+q)-aa;return[af,ah]}function G(ag){O.program=createProgram(p,O.vertexShader,O.fragmentShader);O.positionAttributeLocation=p.getAttribLocation(O.program,"a_position");O.positionBuffer=p.createBuffer();p.bindBuffer(p.ARRAY_BUFFER,O.positionBuffer);var af=[-1,-1,-1,1,1,-1,-1,1,1,1,1,-1,];p.bufferData(p.ARRAY_BUFFER,new Float32Array(af),p.STATIC_DRAW);O.texCoordAttributeLocation=p.getAttribLocation(O.program,"a_texCoord");O.texCoordBuffer=p.createBuffer();B();O.bgTexCoordAttributeLocation=p.getAttribLocation(O.program,"a_bgTexCoord");O.bgTexCoordBuffer=p.createBuffer();n();O.resolutionUniformLocation=p.getUniformLocation(O.program,"u_resolution");O.backgroundImageTintUniformLocation=p.getUniformLocation(O.program,"u_backgroundImageTint");O.backgroundImageBrightnessUniformLocation=p.getUniformLocation(O.program,"u_backgroundImageBrightness");O.pressureColorUniformLocation=p.getUniformLocation(O.program,"u_pressureColor");O.pressureOpacityUniformLocation=p.getUniformLocation(O.program,"u_pressureOpacity");O.pressureCutoffUniformLocation=p.getUniformLocation(O.program,"u_pressureCutoff");O.pressureIORUniformLocation=p.getUniformLocation(O.program,"u_pressureIOR");O.updraftColorUniformLocation=p.getUniformLocation(O.program,"u_updraftColor");O.updraftOpacityUniformLocation=p.getUniformLocation(O.program,"u_updraftOpacity");O.updraftCutoffUniformLocation=p.getUniformLocation(O.program,"u_updraftCutoff");O.updraftIORUniformLocation=p.getUniformLocation(O.program,"u_updraftIOR");O.cloudColorUniformLocation=p.getUniformLocation(O.program,"u_cloudColor");O.cloudOpacityUniformLocation=p.getUniformLocation(O.program,"u_cloudOpacity");O.cloudCutoffUniformLocation=p.getUniformLocation(O.program,"u_cloudCutoff");O.cloudIORUniformLocation=p.getUniformLocation(O.program,"u_cloudIOR");O.rainColorUniformLocation=p.getUniformLocation(O.program,"u_rainColor");O.rainOpacityUniformLocation=p.getUniformLocation(O.program,"u_rainOpacity");O.rainCutoffUniformLocation=p.getUniformLocation(O.program,"u_rainCutoff");O.rainIORUniformLocation=p.getUniformLocation(O.program,"u_rainIOR");O.humidityColorUniformLocation=p.getUniformLocation(O.program,"u_humidityColor");O.humidityOpacityUniformLocation=p.getUniformLocation(O.program,"u_humidityOpacity");O.humidityCutoffUniformLocation=p.getUniformLocation(O.program,"u_humidityCutoff");O.humidityIORUniformLocation=p.getUniformLocation(O.program,"u_humidityIOR");O.temperatureColorUniformLocation=p.getUniformLocation(O.program,"u_temperatureColor");O.temperatureOpacityUniformLocation=p.getUniformLocation(O.program,"u_temperatureOpacity");O.temperatureCutoffUniformLocation=p.getUniformLocation(O.program,"u_temperatureCutoff");O.temperatureIORUniformLocation=p.getUniformLocation(O.program,"u_temperatureIOR");O.humidityTemperatureColorUniformLocation=p.getUniformLocation(O.program,"u_humidityTemperatureColor");O.humidityTemperatureOpacityUniformLocation=p.getUniformLocation(O.program,"u_humidityTemperatureOpacity");O.humidityTemperatureCutoffUniformLocation=p.getUniformLocation(O.program,"u_humidityTemperatureCutoff");O.humidityTemperatureIORUniformLocation=p.getUniformLocation(O.program,"u_humidityTemperatureIOR");O.relativeTemperatureColorUniformLocation=p.getUniformLocation(O.program,"u_relativeTemperatureColor");O.relativeTemperatureOpacityUniformLocation=p.getUniformLocation(O.program,"u_relativeTemperatureOpacity");O.relativeTemperatureCutoffUniformLocation=p.getUniformLocation(O.program,"u_relativeTemperatureCutoff");O.relativeTemperatureIORUniformLocation=p.getUniformLocation(O.program,"u_relativeTemperatureIOR");O.updraftTemperatureColorUniformLocation=p.getUniformLocation(O.program,"u_updraftTemperatureColor");O.updraftTemperatureOpacityUniformLocation=p.getUniformLocation(O.program,"u_updraftTemperatureOpacity");O.updraftTemperatureCutoffUniformLocation=p.getUniformLocation(O.program,"u_updraftTemperatureCutoff");O.updraftTemperatureIORUniformLocation=p.getUniformLocation(O.program,"u_updraftTemperatureIOR");O.globalStabilityUniformLocation=p.getUniformLocation(O.program,"u_globalStability");O.inversionAltitudeUniformLocation=p.getUniformLocation(O.program,"u_inversionAltitude");O.inversionTemperatureUniformLocation=p.getUniformLocation(O.program,"u_inversionTemperature");O.groundInversionDepthUniformLocation=p.getUniformLocation(O.program,"u_groundInversionDepth");O.groundInversionTemperatureUniformLocation=p.getUniformLocation(O.program,"u_groundInversionTemperature");O.u_basefluidLocation=p.getUniformLocation(O.program,"u_basefluid");O.u_solutesLocation=p.getUniformLocation(O.program,"u_solutes");O.u_backgroundLocation=p.getUniformLocation(O.program,"u_background");if(O.backgroundImageTexture){p.deleteTexture(O.backgroundImageTexture)}O.backgroundImageTexture=f();p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.LINEAR);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_S,p.REPEAT);p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,p.REPEAT);p.texImage2D(p.TEXTURE_2D,0,p.RGBA,p.RGBA,p.UNSIGNED_BYTE,K);if(O.transferBasefluidTexture){p.deleteTexture(O.transferBasefluidTexture)}O.transferBasefluidTexture=f();p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.LINEAR);p.texImage2D(p.TEXTURE_2D,0,p.RGBA32F,b.resolution,b.resolution,0,p.RGBA,p.FLOAT,null);if(O.transferBasefluidFramebuffer){p.deleteFramebuffer(O.transferBasefluidFramebuffer)}O.transferBasefluidFramebuffer=p.createFramebuffer();p.bindFramebuffer(p.FRAMEBUFFER,O.transferBasefluidFramebuffer);p.framebufferTexture2D(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,p.TEXTURE_2D,O.transferBasefluidTexture,0);if(O.transferSolutesTexture){p.deleteTexture(O.transferSolutesTexture)}O.transferSolutesTexture=f();p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.LINEAR);p.texImage2D(p.TEXTURE_2D,0,p.RGBA32F,b.resolution,b.resolution,0,p.RGBA,p.FLOAT,null);if(O.transferSolutesFramebuffer){p.deleteFramebuffer(O.transferSolutesFramebuffer)}O.transferSolutesFramebuffer=p.createFramebuffer();p.bindFramebuffer(p.FRAMEBUFFER,O.transferSolutesFramebuffer);p.framebufferTexture2D(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,p.TEXTURE_2D,O.transferSolutesTexture,0)}var L=[];function t(af){L[af-1]=true;if(L.every(function(ag){return ag})){r()}}var E=["./images/aileron-grey.png","./images/squares/squares_00.png","./images/squares/squares_01.png","./images/squares/squares_02.png","./images/squares/squares_03.png","./images/hexes/hexes_00.png","./images/hexes/hexes_01.png","./images/aileron.png","./images/aileron-inv.png",];var K=new Image();function H(){if(O.backgroundImageTexture){K.onload=function(){p.bindTexture(p.TEXTURE_2D,O.backgroundImageTexture);p.texImage2D(p.TEXTURE_2D,0,p.RGBA,p.RGBA,p.UNSIGNED_BYTE,K);n();e()};K.src=E[b.backgroundImage]}}var a=new XMLHttpRequest();var ac=L.push(false);a.open("GET","shaders/weathersolver.vert",true);a.onload=function(af){if(this.status==200){D.vertexShader=createShader(p,p.VERTEX_SHADER,a.response);t(ac)}};a.send(null);var X=new XMLHttpRequest();var U=L.push(false);X.open("GET","shaders/weathersolver.frag",true);X.onload=function(af){if(this.status==200){D.fragmentShader=createShader(p,p.FRAGMENT_SHADER,X.response);t(U)}};X.send(null);var Z=new XMLHttpRequest();var w=L.push(false);Z.open("GET","shaders/weatherrenderer.vert",true);Z.onload=function(af){if(this.status==200){O.vertexShader=createShader(p,p.VERTEX_SHADER,Z.response);t(w)}};Z.send(null);var Y=new XMLHttpRequest();var v=L.push(false);Y.open("GET","shaders/weatherrenderer.frag",true);Y.onload=function(af){if(this.status==200){O.fragmentShader=createShader(p,p.FRAGMENT_SHADER,Y.response);t(v)}};Y.send(null);function j(ah){T=new dat.GUI({load:ah});T.remember(b);var ag=T.addFolder("Simulation Params");var al=ag.addFolder("Stability");al.add(b,"globalWind").min(-1).max(1).step(0.01);al.add(b,"globalStability").min(0).max(0.5).step(0.01);al.add(b,"inversionAltitude").min(0.5).max(1).step(0.01);al.add(b,"inversionTemperature").min(0.5).max(1.5).step(0.01);al.add(b,"groundInversionDepth").min(0).max(0.5).step(0.01);al.add(b,"groundInversionTemperature").min(0).max(0.5).step(0.01);al.add(b,"heatDisipationRate").min(0).max(0.005).step(0.0001);al.add(b,"buoyancyFactor").min(0).max(0.1).step(0.001);al.add(b,"rainFallingFactor").min(0).max(0.1).step(0.001);var aj=ag.addFolder("Water Content");aj.add(b,"temperatureDiffusion").min(0).max(0.1).step(0.01);aj.add(b,"humidityDiffusion").min(0).max(0.1).step(0.01);aj.add(b,"condensationFactor").min(0).max(1).step(0.01);aj.add(b,"mistDiffusion").min(0).max(0.1).step(0.01);aj.add(b,"mistToRainFactor").min(0).max(0.01).step(0.0001);aj.add(b,"rainFallDiffusion").min(0).max(1).step(0.001);aj.add(b,"rainEvaporation").min(0).max(0.001).step(0.00001);aj.add(b,"initialHumidity").min(0).max(1).step(0.01);aj.add(b,"condensationLevel").min(0).max(1).step(0.01);aj.add(b,"latentHeat").min(0).max(5).step(0.1);var af=T.addFolder("Solver Settings");af.add(b,"resolution",[64,128,256,512,1024,2048,4096]).onChange(V);af.add(b,"pressureSolveSteps").min(1).max(30).step(1);af.add(b,"diffusion").min(0).max(1).step(0.01);var au=T.addFolder("Display Options");au.add(b,"displayOutline").onChange(e);au.add(b,"backgroundImage",[0,1,2,3,4,5,6,7,8]).onChange(H);au.addColor(b,"backgroundImageTint").onChange(e);au.add(b,"backgroundImageBrightness").min(-1).max(1).step(0.01).onChange(e);var at=au.addFolder("Pressure");at.addColor(b,"pressureColor").onChange(e);at.add(b,"pressureOpacity").min(0).max(100000).step(100).onChange(e);at.add(b,"pressureCutoff").min(0).max(0.01).step(0.00001).onChange(e);at.add(b,"pressureIOR").min(-100).max(100).step(1).onChange(e);var ar=au.addFolder("Updraft");ar.addColor(b,"updraftColor").onChange(e);ar.add(b,"updraftOpacity").min(0).max(15).step(0.01).onChange(e);ar.add(b,"updraftCutoff").min(0).max(1).step(0.001).onChange(e);ar.add(b,"updraftIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var aq=au.addFolder("Cloud");aq.addColor(b,"cloudColor").onChange(e);aq.add(b,"cloudOpacity").min(0).max(70).step(0.1).onChange(e);aq.add(b,"cloudCutoff").min(0).max(1).step(0.001).onChange(e);aq.add(b,"cloudIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var ap=au.addFolder("Rain");ap.addColor(b,"rainColor").onChange(e);ap.add(b,"rainOpacity").min(0).max(30).step(0.1).onChange(e);ap.add(b,"rainCutoff").min(0).max(1).step(0.001).onChange(e);ap.add(b,"rainIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var ao=au.addFolder("Humidity");ao.addColor(b,"humidityColor").onChange(e);ao.add(b,"humidityOpacity").min(0).max(15).step(0.1).onChange(e);ao.add(b,"humidityCutoff").min(0).max(1).step(0.001).onChange(e);ao.add(b,"humidityIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var an=au.addFolder("Temperature");an.addColor(b,"temperatureColor").onChange(e);an.add(b,"temperatureOpacity").min(0).max(15).step(0.1).onChange(e);an.add(b,"temperatureCutoff").min(0).max(1).step(0.001).onChange(e);an.add(b,"temperatureIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var am=au.addFolder("Humidity Temperature");am.addColor(b,"humidityTemperatureColor").onChange(e);am.add(b,"humidityTemperatureOpacity").min(0).max(15).step(0.01).onChange(e);am.add(b,"humidityTemperatureCutoff").min(0).max(1).step(0.001).onChange(e);am.add(b,"humidityTemperatureIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var ak=au.addFolder("Relative Temperature");ak.addColor(b,"relativeTemperatureColor").onChange(e);ak.add(b,"relativeTemperatureOpacity").min(0).max(15).step(0.01).onChange(e);ak.add(b,"relativeTemperatureCutoff").min(0).max(1).step(0.001).onChange(e);ak.add(b,"relativeTemperatureIOR").min(-0.1).max(0.1).step(0.001).onChange(e);var ai=au.addFolder("Updraft Temperature");ai.addColor(b,"updraftTemperatureColor").onChange(e);ai.add(b,"updraftTemperatureOpacity").min(0).max(15).step(0.01).onChange(e);ai.add(b,"updraftTemperatureCutoff").min(0).max(1).step(0.001).onChange(e);ai.add(b,"updraftTemperatureIOR").min(-0.1).max(0.1).step(0.001).onChange(e);T.add(b,"runSimulation");T.add(b,"stopSimulation");T.add(b,"stepSimulation");T.add(b,"basefluid").listen();T.add(b,"solutes").listen()}var ad=new XMLHttpRequest();var y=L.push(false);ad.open("GET","presets.json",true);ad.onload=function(ag){if(this.status==200){j(JSON.parse(ad.response));var af=L.push(false);K.onload=function(){t(af)};K.src=E[b.backgroundImage];t(y)}};ad.send(null);function ae(ah){var ag;var af;if(ah==null){ag=p.canvas.width;af=p.canvas.height}else{ag=b.resolution;af=b.resolution}p.bindFramebuffer(p.FRAMEBUFFER,ah);p.viewport(0,0,parseFloat(ag),parseFloat(af))}var C=0;var M=1;var F=0;var P=1;function z(){F=(F==0)?1:0;P=(P==0)?1:0}function ab(){C=(C==0)?1:0;M=(M==0)?1:0}function x(al,ak){p.useProgram(D.program);p.uniform1i(D.u_basefluidLocation,0);p.uniform1i(D.u_solutesLocation,1);p.uniform1i(D.u_groundLocation,2);p.activeTexture(p.TEXTURE0);p.bindTexture(p.TEXTURE_2D,D.basefluidTextures[C]);p.activeTexture(p.TEXTURE1);p.bindTexture(p.TEXTURE_2D,D.solutesTextures[F]);p.activeTexture(p.TEXTURE2);d();ae(al);p.uniform1f(D.resolutionUniformLocation,b.resolution);p.enableVertexAttribArray(D.positionAttributeLocation);p.bindBuffer(p.ARRAY_BUFFER,D.positionBuffer);var an=2;var aj=p.FLOAT;var ah=false;var af=0;var ag=0;p.vertexAttribPointer(D.positionAttributeLocation,an,aj,ah,af,ag);p.enableVertexAttribArray(D.texCoordAttributeLocation);p.bindBuffer(p.ARRAY_BUFFER,D.texCoordBuffer);var an=2;var aj=p.FLOAT;var ah=false;var af=0;var ag=0;p.vertexAttribPointer(D.texCoordAttributeLocation,an,aj,ah,af,ag);p.uniform1i(D.calcFunctionUniformLocation,ak);p.uniform1f(D.diffusionUniformLocation,b.diffusion);p.uniform1f(D.buoyancyFactorUniformLocation,b.buoyancyFactor);p.uniform1f(D.rainFallingFactorUniformLocation,b.rainFallingFactor);p.uniform1f(D.globalWindUniformLocation,b.globalWind);p.uniform1f(D.globalStabilityUniformLocation,b.globalStability);p.uniform1f(D.inversionAltitudeUniformLocation,b.inversionAltitude);p.uniform1f(D.inversionTemperatureUniformLocation,b.inversionTemperature);p.uniform1f(D.groundInversionDepthUniformLocation,b.groundInversionDepth);p.uniform1f(D.groundInversionTemperatureUniformLocation,b.groundInversionTemperature);p.uniform1f(D.heatDisipationRateUniformLocation,b.heatDisipationRate);p.uniform1f(D.temperatureDiffusionUniformLocation,b.temperatureDiffusion);p.uniform1f(D.humidityDiffusionUniformLocation,b.humidityDiffusion);p.uniform1f(D.condensationFactorUniformLocation,b.condensationFactor);p.uniform1f(D.mistDiffusionUniformLocation,b.mistDiffusion);p.uniform1f(D.mistToRainFactorUniformLocation,b.mistToRainFactor);p.uniform1f(D.rainFallDiffusionUniformLocation,b.rainFallDiffusion);p.uniform1f(D.rainEvaporationUniformLocation,b.rainEvaporation);p.uniform1f(D.initialHumidityUniformLocation,b.initialHumidity);p.uniform1f(D.condensationLevelUniformLocation,b.condensationLevel);p.uniform1f(D.latentHeatUniformLocation,b.latentHeat);var am=p.TRIANGLES;var ag=0;var ai=6;p.drawArrays(am,ag,ai)}function m(){var ah=I(s);x(O.transferBasefluidFramebuffer,0);p.readPixels(ah[0]*l,ah[1]*l,1,1,p.RGBA,p.FLOAT,g);x(O.transferSolutesFramebuffer,1);p.readPixels(ah[0]*l,ah[1]*l,1,1,p.RGBA,p.FLOAT,u);b.basefluid=" vx: "+g[0].toFixed(2)+", vy: "+g[1].toFixed(2)+", p: "+g[2].toFixed(2)+", div: "+g[3].toFixed(2);b.solutes=" t: "+u[0].toFixed(3)+", h: "+u[2].toFixed(3)+", m: "+u[3].toFixed(3)+", r: "+u[1].toFixed(3);p.useProgram(O.program);p.uniform1i(O.u_basefluidLocation,0);p.uniform1i(O.u_solutesLocation,1);p.uniform1i(O.u_backgroundLocation,2);p.activeTexture(p.TEXTURE0);p.bindTexture(p.TEXTURE_2D,O.transferBasefluidTexture);p.activeTexture(p.TEXTURE1);p.bindTexture(p.TEXTURE_2D,O.transferSolutesTexture);p.activeTexture(p.TEXTURE2);p.bindTexture(p.TEXTURE_2D,O.backgroundImageTexture);ae(null);p.uniform2f(O.resolutionUniformLocation,b.resolution,b.resolution);p.enableVertexAttribArray(O.positionAttributeLocation);p.bindBuffer(p.ARRAY_BUFFER,O.positionBuffer);p.vertexAttribPointer(O.positionAttributeLocation,2,p.FLOAT,false,0,0);p.enableVertexAttribArray(O.texCoordAttributeLocation);p.bindBuffer(p.ARRAY_BUFFER,O.texCoordBuffer);p.vertexAttribPointer(O.texCoordAttributeLocation,2,p.FLOAT,false,0,0);p.enableVertexAttribArray(O.bgTexCoordAttributeLocation);p.bindBuffer(p.ARRAY_BUFFER,O.bgTexCoordBuffer);p.vertexAttribPointer(O.bgTexCoordAttributeLocation,2,p.FLOAT,false,0,0);p.uniform3f(O.backgroundImageTintUniformLocation,b.backgroundImageTint[0]/256,b.backgroundImageTint[1]/256,b.backgroundImageTint[2]/256);p.uniform1f(O.backgroundImageBrightnessUniformLocation,b.backgroundImageBrightness);p.uniform3f(O.pressureColorUniformLocation,b.pressureColor[0]/256,b.pressureColor[1]/256,b.pressureColor[2]/256);p.uniform1f(O.pressureOpacityUniformLocation,b.pressureOpacity);p.uniform1f(O.pressureCutoffUniformLocation,b.pressureCutoff);p.uniform1f(O.pressureIORUniformLocation,b.pressureIOR);p.uniform3f(O.updraftColorUniformLocation,b.updraftColor[0]/256,b.updraftColor[1]/256,b.updraftColor[2]/256);p.uniform1f(O.updraftOpacityUniformLocation,b.updraftOpacity);p.uniform1f(O.updraftCutoffUniformLocation,b.updraftCutoff);p.uniform1f(O.updraftIORUniformLocation,b.updraftIOR);p.uniform3f(O.cloudColorUniformLocation,b.cloudColor[0]/256,b.cloudColor[1]/256,b.cloudColor[2]/256);p.uniform1f(O.cloudOpacityUniformLocation,b.cloudOpacity);p.uniform1f(O.cloudCutoffUniformLocation,b.cloudCutoff);p.uniform1f(O.cloudIORUniformLocation,b.cloudIOR);p.uniform3f(O.rainColorUniformLocation,b.rainColor[0]/256,b.rainColor[1]/256,b.rainColor[2]/256);p.uniform1f(O.rainOpacityUniformLocation,b.rainOpacity);p.uniform1f(O.rainCutoffUniformLocation,b.rainCutoff);p.uniform1f(O.rainIORUniformLocation,b.rainIOR);p.uniform3f(O.humidityColorUniformLocation,b.humidityColor[0]/256,b.humidityColor[1]/256,b.humidityColor[2]/256);p.uniform1f(O.humidityOpacityUniformLocation,b.humidityOpacity);p.uniform1f(O.humidityCutoffUniformLocation,b.humidityCutoff);p.uniform1f(O.humidityIORUniformLocation,b.humidityIOR);p.uniform3f(O.temperatureColorUniformLocation,b.temperatureColor[0]/256,b.temperatureColor[1]/256,b.temperatureColor[2]/256);p.uniform1f(O.temperatureOpacityUniformLocation,b.temperatureOpacity);p.uniform1f(O.temperatureCutoffUniformLocation,b.temperatureCutoff);p.uniform1f(O.temperatureIORUniformLocation,b.temperatureIOR);p.uniform3f(O.humidityTemperatureColorUniformLocation,b.humidityTemperatureColor[0]/256,b.humidityTemperatureColor[1]/256,b.humidityTemperatureColor[2]/256);p.uniform1f(O.humidityTemperatureOpacityUniformLocation,b.humidityTemperatureOpacity);p.uniform1f(O.humidityTemperatureCutoffUniformLocation,b.humidityTemperatureCutoff);p.uniform1f(O.humidityTemperatureIORUniformLocation,b.humidityTemperatureIOR);p.uniform3f(O.relativeTemperatureColorUniformLocation,b.relativeTemperatureColor[0]/256,b.relativeTemperatureColor[1]/256,b.relativeTemperatureColor[2]/256);p.uniform1f(O.relativeTemperatureOpacityUniformLocation,b.relativeTemperatureOpacity);p.uniform1f(O.relativeTemperatureCutoffUniformLocation,b.relativeTemperatureCutoff);p.uniform1f(O.relativeTemperatureIORUniformLocation,b.relativeTemperatureIOR);p.uniform3f(O.updraftTemperatureColorUniformLocation,b.updraftTemperatureColor[0]/256,b.updraftTemperatureColor[1]/256,b.updraftTemperatureColor[2]/256);p.uniform1f(O.updraftTemperatureOpacityUniformLocation,b.updraftTemperatureOpacity);p.uniform1f(O.updraftTemperatureCutoffUniformLocation,b.updraftTemperatureCutoff);p.uniform1f(O.updraftTemperatureIORUniformLocation,b.updraftTemperatureIOR);p.uniform1f(O.globalStabilityUniformLocation,b.globalStability);p.uniform1f(O.inversionAltitudeUniformLocation,b.inversionAltitude);p.uniform1f(O.inversionTemperatureUniformLocation,b.inversionTemperature);p.uniform1f(O.groundInversionDepthUniformLocation,b.groundInversionDepth);p.uniform1f(O.groundInversionTemperatureUniformLocation,b.groundInversionTemperature);var af=p.TRIANGLES;var ai=0;var ag=6;p.drawArrays(af,ai,ag)}var e=function(){if(b.displayOutline){k.style.border="1px  solid red"}else{k.style.border="none"}if(!o){m()}};var c=function(af){x(D.basefluidFramebuffers[M],4);ab();for(var ag=1;ag<b.pressureSolveSteps;ag+=1){x(D.basefluidFramebuffers[M],5);ab()}x(D.basefluidFramebuffers[M],6);ab()};function i(af,ag,ah){h[af*4+0]=ag;h[af*4+2]=ah}J=function(){i(2,70,0);i(3,70,10);i(4,170,10);i(5,70,10);i(8,170,10);i(9,70,0);i(12,0,50);i(13,0,50);x(D.basefluidFramebuffers[M],9);ab();x(D.solutesFramebuffers[P],10);z();x(D.basefluidFramebuffers[M],2);ab();x(D.solutesFramebuffers[P],7);z();c();x(D.basefluidFramebuffers[M],3);ab();x(D.solutesFramebuffers[P],8);z();c();m();if(o){requestAnimationFrame(J)}};var l=256;function V(af){if(af!=l){r();l=af}}};